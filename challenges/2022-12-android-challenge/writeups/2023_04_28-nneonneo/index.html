<!doctype html><html class=dark-mode lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=manifest href=manifest.webmanifest><link rel=icon type=image/svg+xml href=/favicon/favicon.svg><link rel=icon type=image/png href=/favicon/favicon_hu17561484188248076563.png><link rel="shortcut icon" type=image/png href=/favicon/favicon_hu17893542909638419879.png><link rel=apple-touch-icon type=image/png href=/favicon/favicon_hu17893542909638419879.png><meta name=description content="Writeup for obfuscator.re Challenge 1
Author: Robert Xiao nneonneo@gmail.com
We&rsquo;re provided an APK file, and told that it has been protected by O-MVLL (native code), dProtect (dex code), ELF format modifications, and runtime application self protection (RASP). Let&rsquo;s dive in!
Our first stop is to unzip the APK. There&rsquo;s a single native library, lib/arm64-v8a/liba1re03.so weighing in at 27MB, along with bits of Kotlin data suggesting that parts of the app are written in Kotlin."><meta property="og:type" content="website"><meta property="og:description" content="Writeup for obfuscator.re Challenge 1
Author: Robert Xiao nneonneo@gmail.com
We&rsquo;re provided an APK file, and told that it has been protected by O-MVLL (native code), dProtect (dex code), ELF format modifications, and runtime application self protection (RASP). Let&rsquo;s dive in!
Our first stop is to unzip the APK. There&rsquo;s a single native library, lib/arm64-v8a/liba1re03.so weighing in at 27MB, along with bits of Kotlin data suggesting that parts of the app are written in Kotlin."><meta property="og:title" content="Writeup by Robert Bo Xiao | Open Obfuscator"><meta property="og:site_name" content="Open Obfuscator: A free and open-source solution for obfuscating mobile applications."><meta property="og:url" content="https://obfuscator.re/challenges/2022-12-android-challenge/writeups/2023_04_28-nneonneo/"><meta property="og:locale" content="en-us"><meta property="article:modified_time" content="2023-08-27T10:55:27+02:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@open_obfuscator"><meta name=twitter:creator content="@rh0main"><meta name=twitter:title content="Writeup by Robert Bo Xiao | Open Obfuscator"><meta name=twitter:description content="Writeup for obfuscator.re Challenge 1
Author: Robert Xiao nneonneo@gmail.com
We&rsquo;re provided an APK file, and told that it has been protected by O-MVLL (native code), dProtect (dex code), ELF format modifications, and runtime application self protection (RASP). Let&rsquo;s dive in!
Our first stop is to unzip the APK. There&rsquo;s a single native library, lib/arm64-v8a/liba1re03.so weighing in at 27MB, along with bits of Kotlin data suggesting that parts of the app are written in Kotlin."><meta name=twitter:domain content="https://obfuscator.re/challenges/2022-12-android-challenge/writeups/2023_04_28-nneonneo/"><title>Writeup by Robert Bo Xiao | Challenges</title>
<link rel=canonical href=https://obfuscator.re/challenges/2022-12-android-challenge/writeups/2023_04_28-nneonneo/><link rel=stylesheet href=/css/fa-all.min.css><link rel=stylesheet href=/vendor/swiper/swiper-bundle.min.css><link rel=stylesheet href=/vendor/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/css/theme.min.css></head><body><main class=page-wrapper><header class="header navbar navbar-expand-lg navbar-dark position-absolute navbar-sticky"><div class="container px-3"><a href=https://obfuscator.re/ class="navbar-brand pe-3"><svg width="44.142574" height="40.444458" viewBox="0 0 11.679389 10.70093" id="svg20282" inkscape:version="1.2.1 (9c6d41e410, 2022-07-14, custom)" sodipodi:docname="logo.svg" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:svg="http://www.w3.org/2000/svg"><sodipodi:namedview id="namedview20284" pagecolor="#ffffff" bordercolor="#000000" borderopacity=".25" inkscape:showpageshadow="2" inkscape:pageopacity="0" inkscape:pagecheckerboard="0" inkscape:deskcolor="#d1d1d1" inkscape:document-units="mm" showgrid="false" inkscape:zoom="7.319248" inkscape:cx="51.576337" inkscape:cy="24.661003" inkscape:window-width="1714" inkscape:window-height="1411" inkscape:window-x="1720" inkscape:window-y="23" inkscape:window-maximized="1" inkscape:current-layer="layer1"/><defs id="defs20279"/><g inkscape:label="Layer 1" inkscape:groupmode="layer" id="layer1" transform="translate(-0.38727107,-0.37705709)"><g id="g34542" transform="matrix(0.01393956,0,0,0.01393956,0.31874133,0.37705711)" style="font-size:80px;font-family:brolink demo;-inkscape-font-specification:'Brolink DEMO, Normal';display:inline;opacity:.778276;stroke-width:37.9613;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:2;stroke-dasharray:4.79781,9.59564" inkscape:label="mascott"><g id="g34508" style="stroke-width:37.9613"><path d="m162.144 193.719s67.743-16.576 50.853-114.74c0 0 81.408-135.816 257.901-50.836.0.0-114.839 23.251-86.081 138.61.0.0-77.272-16.404-96.43 49.396.0.0-39.238-26.305-76.384 13.254.001.0-31.497 4.809-49.859-35.684z" fill="#5bc992" id="path34504" style="fill:#0d3758;fill-opacity:1;stroke-width:258.859"/><path d="m168.14 196.604c-3.557.0-6.756-2.472-7.539-6.09-.898-4.15 1.723-8.243 5.861-9.168 1.823-.428 42.24-10.743 40.627-79.558-.229-9.782-1.411-20.039-3.511-30.485l-2.197-10.93c-.84-4.18 1.868-8.251 6.048-9.092 4.184-.838 8.251 1.868 9.092 6.048l2.197 10.93c2.277 11.327 3.559 22.486 3.81 33.167.547 23.372-3.317 55.876-24.841 77.998-13.361 13.732-27.318 16.877-27.906 17.004-.55.118-1.1.176-1.641.176z" fill="#0bb494" id="path34506" style="fill:#59aae8;fill-opacity:.992157;stroke-width:258.859"/></g><g id="g34514" style="stroke-width:37.9613"><path d="m230.826 252.7c40.616-35.987 77.278-6.195 77.278-6.195 25.11-63.766 100.553-40.346 100.553-40.346-18.06-117.51 98.427-130.134 98.427-130.134-167.958-100.804-261.476 26.976-261.476 26.976 7.818 99.299-61.159 109.594-61.159 109.594s10.647 24.683 46.377 40.105z" fill="#6fd7a3" id="path34510" style="fill:#135587;fill-opacity:1;stroke-width:258.859"/><path d="m190.86 216.05c-3.848.0-7.177-2.872-7.655-6.788-.514-4.215 2.472-8.051 6.676-8.593 1.85-.258 43.048-6.821 47.752-75.499.668-9.759.432-20.08-.702-30.678l-1.186-11.085c-.453-4.24 2.616-8.046 6.856-8.499 4.242-.449 8.046 2.616 8.499 6.856l1.186 11.085c1.23 11.492 1.483 22.721.753 33.377-1.598 23.324-8.426 55.337-31.888 75.392-14.564 12.449-28.751 14.301-29.348 14.374-.316.039-.631.058-.943.058z" fill="#0bb494" id="path34512" style="fill:#59aae8;fill-opacity:.992157;stroke-width:258.859"/></g><path d="m99.22 32.25c54.02-16.304 94.124 31.976 82.031 97.634-11.942 64.843 13.555 101.705 49.575 122.816 34.936 20.476 92.97 61.763 97.24 138.002 7.207 128.69-146.88 153.812-189.774 79.616-38.092-65.889 25.07-126.332 25.07-126.332l15.768 13.085s-54.212 57.459-6.717 98.644c41.377 35.88 119.62 4.994 94.473-63.798-22.727-62.169-113.186-48.785-155.96-107.49C70.063 228.345 104.751 176.066 120.847 144.993c26.901-51.934 11.207-94.471-22.844-80.767z" fill="#c9f6b0" id="path34516" style="fill:#1b71af;fill-opacity:1;stroke-width:258.859"/><g id="g34520" style="stroke-width:37.9613"><path d="M328.066 390.702C323.797 314.463 265.762 273.176 230.826 252.7c-36.02-21.111-61.517-57.973-49.575-122.816C193.344 64.227 153.24 15.946 99.22 32.25l-.016.427c31.181 11.593 49.582 49.885 40.867 97.207-11.942 64.843 13.555 101.705 49.575 122.816 34.936 20.476 92.97 61.763 97.24 138.002 3.97 70.889-41.004 110.348-89.374 119.094 59.897 11.218 135.657-27.974 130.554-119.094z" fill="#bbf49b" id="path34518" style="fill:#155d91;fill-opacity:1;stroke-width:258.859"/></g><path d="M86.13 29.061 146.528.0s-10.295 53.02-52.157 74.817L75.834 69.492z" fill="#6fd7a3" id="path34522" style="fill:#0cf;fill-opacity:1;stroke-width:258.859"/><path d="m108.988.0-14.942 49.333.325 25.484c.132 10.356-5.648 19.894-14.922 24.625l-53.66 27.374C13.17 133.254-.159 119.45 6.856 107.202c8.309-14.507 17.855-31.646 27.245-49.53C41.851 42.911 53.79 30.729 68.409 22.59z" fill="#c9f6b0" id="path34524" style="fill:#2a95e1;fill-opacity:1;stroke-width:258.859"/><path d="m181.814 315.601c4.614-3.907 11.558.252 10.29 6.164l-6.293 29.354-7.207 33.619c-1.15 5.364-8.11 6.832-11.328 2.389L157.07 373.035c-1.033-1.427-2.614-2.359-4.362-2.573l-16.799-2.056c-5.486-.672-7.543-7.554-3.325-11.126l26.177-22.163z" fill="#6fd7a3" id="path34526" style="fill:#2ad4ff;fill-opacity:.992157;stroke-width:258.859"/><path d="m408.662 213.882c-2.855.0-5.599-1.59-6.939-4.325-.083-.168-8.514-17.05-27.948-36.153-17.846-17.542-48.949-40.642-95.775-51.077-4.162-.927-6.784-5.054-5.857-9.216.927-4.162 5.05-6.787 9.216-5.857 50.722 11.302 84.422 36.5 103.761 55.648 21.095 20.887 30.105 39.107 30.478 39.872 1.869 3.833.277 8.455-3.556 10.324-1.091.533-2.244.784-3.38.784z" fill="#0bb494" id="path34528" style="fill:#59aae8;fill-opacity:.992157;stroke-width:258.859"/><path d="m308.106 254.226c-.035.0-.068.0-.103-.001-4.254-.056-7.66-3.541-7.62-7.792.0-.459-.233-27.156-22.522-73.746-1.84-3.847-.214-8.457 3.633-10.298s8.457-.214 10.298 3.633c24.143 50.465 24.049 79.377 24.033 80.583-.056 4.231-3.502 7.621-7.719 7.621z" fill="#0bb494" id="path34530" style="fill:#59aae8;fill-opacity:.992157;stroke-width:258.859"/><g fill="#6fd7a3" id="g34540" style="display:inline;stroke-width:258.859"><path d="m293.41 353.127c-2.935.0-5.74-1.682-7.034-4.528-1.765-3.882-.048-8.459 3.834-10.224 6.955-3.161 18.792-10.715 18.911-10.791 3.592-2.297 8.368-1.248 10.665 2.345s1.248 8.367-2.345 10.665c-.522.334-12.881 8.222-20.84 11.839-1.036.47-2.122.694-3.191.694z" id="path34532" style="fill:#2b97e2;fill-opacity:.992157;stroke-width:37.9613"/><path d="m308.098 407.232c-4.104.0-7.52-3.231-7.707-7.372-.193-4.26 3.104-7.87 7.364-8.063l20.207-.915c4.259-.189 7.87 3.104 8.063 7.364s-3.104 7.87-7.364 8.063l-20.207.915c-.119.005-.238.008-.356.008z" id="path34534" style="fill:#2b97e2;fill-opacity:.992157;stroke-width:37.9613"/><path d="m310.641 470.991c-1.381.0-2.779-.37-4.042-1.148l-14.183-8.736c-3.631-2.236-4.762-6.993-2.525-10.623 2.236-3.632 6.993-4.762 10.623-2.525l14.184 8.736c3.631 2.236 4.762 6.993 2.525 10.623-1.459 2.368-3.99 3.673-6.582 3.673z" id="path34536" style="fill:#2b97e2;fill-opacity:.992157;stroke-width:37.9613"/><path d="m258.788 512c-2.901.0-5.679-1.642-6.994-4.441l-7.245-15.427c-1.813-3.86-.153-8.458 3.707-10.271 3.858-1.813 8.458-.153 10.271 3.707l7.245 15.427c1.813 3.86.153 8.458-3.707 10.271-1.06.498-2.177.734-3.277.734z" id="path34538" style="fill:#2b97e2;fill-opacity:.992157;stroke-width:37.9613"/></g></g><g id="g49341" transform="matrix(-0.01393956,0,0,0.01393956,12.135191,3.9409316)" style="font-size:80px;font-family:brolink demo;-inkscape-font-specification:'Brolink DEMO, Normal';display:inline;opacity:.778276;stroke-width:37.9613;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:2;stroke-dasharray:4.79781,9.59566" inkscape:label="mascott"><g id="g49307" style="stroke-width:37.9613"><path d="m162.144 193.719s67.743-16.576 50.853-114.74c0 0 81.408-135.816 257.901-50.836.0.0-114.839 23.251-86.081 138.61.0.0-77.272-16.404-96.43 49.396.0.0-39.238-26.305-76.384 13.254.001.0-31.497 4.809-49.859-35.684z" fill="#5bc992" id="path49303" style="fill:#7c232d;fill-opacity:.992157;stroke-width:258.859"/><path d="m168.14 196.604c-3.557.0-6.756-2.472-7.539-6.09-.898-4.15 1.723-8.243 5.861-9.168 1.823-.428 42.24-10.743 40.627-79.558-.229-9.782-1.411-20.039-3.511-30.485l-2.197-10.93c-.84-4.18 1.868-8.251 6.048-9.092 4.184-.838 8.251 1.868 9.092 6.048l2.197 10.93c2.277 11.327 3.559 22.486 3.81 33.167.547 23.372-3.317 55.876-24.841 77.998-13.361 13.732-27.318 16.877-27.906 17.004-.55.118-1.1.176-1.641.176z" fill="#0bb494" id="path49305" style="fill:#f45b69;fill-opacity:.992157;stroke-width:258.859"/></g><g id="g49313" style="stroke-width:37.9613"><path d="m230.826 252.7c40.616-35.987 77.278-6.195 77.278-6.195 25.11-63.766 100.553-40.346 100.553-40.346-18.06-117.51 98.427-130.134 98.427-130.134-167.958-100.804-261.476 26.976-261.476 26.976 7.818 99.299-61.159 109.594-61.159 109.594s10.647 24.683 46.377 40.105z" fill="#6fd7a3" id="path49309" style="fill:#9c2d3c;fill-opacity:.992157;stroke-width:258.859"/><path d="m190.86 216.05c-3.848.0-7.177-2.872-7.655-6.788-.514-4.215 2.472-8.051 6.676-8.593 1.85-.258 43.048-6.821 47.752-75.499.668-9.759.432-20.08-.702-30.678l-1.186-11.085c-.453-4.24 2.616-8.046 6.856-8.499 4.242-.449 8.046 2.616 8.499 6.856l1.186 11.085c1.23 11.492 1.483 22.721.753 33.377-1.598 23.324-8.426 55.337-31.888 75.392-14.564 12.449-28.751 14.301-29.348 14.374-.316.039-.631.058-.943.058z" fill="#0bb494" id="path49311" style="opacity:1;fill:#f45b69;fill-opacity:1;stroke-width:258.859"/></g><path d="m99.22 32.25c54.02-16.304 94.124 31.976 82.031 97.634-11.942 64.843 13.555 101.705 49.575 122.816 34.936 20.476 92.97 61.763 97.24 138.002 7.207 128.69-146.88 153.812-189.774 79.616-38.092-65.889 25.07-126.332 25.07-126.332l15.768 13.085s-54.212 57.459-6.717 98.644c41.377 35.88 119.62 4.994 94.473-63.798-22.727-62.169-113.186-48.785-155.96-107.49C70.063 228.345 104.751 176.066 120.847 144.993c26.901-51.934 11.207-94.471-22.844-80.767z" fill="#c9f6b0" id="path49315" style="fill:#9d2a35;fill-opacity:1;stroke-width:258.859"/><g id="g49319" style="stroke-width:37.9613"><path d="M328.066 390.702C323.797 314.463 265.762 273.176 230.826 252.7c-36.02-21.111-61.517-57.973-49.575-122.816C193.344 64.227 153.24 15.946 99.22 32.25l-.016.427c31.181 11.593 49.582 49.885 40.867 97.207-11.942 64.843 13.555 101.705 49.575 122.816 34.936 20.476 92.97 61.763 97.24 138.002 3.97 70.889-41.004 110.348-89.374 119.094 59.897 11.218 135.657-27.974 130.554-119.094z" fill="#bbf49b" id="path49317" style="fill:#c73849;fill-opacity:.992157;stroke-width:258.859"/></g><path d="M86.13 29.061 146.528.0s-10.295 53.02-52.157 74.817L75.834 69.492z" fill="#6fd7a3" id="path49321" style="fill:#7f2d37;fill-opacity:1;stroke-width:258.859"/><path d="m108.988.0-14.942 49.333.325 25.484c.132 10.356-5.648 19.894-14.922 24.625l-53.66 27.374C13.17 133.254-.159 119.45 6.856 107.202c8.309-14.507 17.855-31.646 27.245-49.53C41.851 42.911 53.79 30.729 68.409 22.59z" fill="#c9f6b0" id="path49323" style="fill:#ee505f;fill-opacity:1;stroke-width:258.859"/><path d="m181.814 315.601c4.614-3.907 11.558.252 10.29 6.164l-6.293 29.354-7.207 33.619c-1.15 5.364-8.11 6.832-11.328 2.389L157.07 373.035c-1.033-1.427-2.614-2.359-4.362-2.573l-16.799-2.056c-5.486-.672-7.543-7.554-3.325-11.126l26.177-22.163z" fill="#6fd7a3" id="path49325" style="fill:#eb4f5d;fill-opacity:1;stroke-width:258.859"/><path d="m408.662 213.882c-2.855.0-5.599-1.59-6.939-4.325-.083-.168-8.514-17.05-27.948-36.153-17.846-17.542-48.949-40.642-95.775-51.077-4.162-.927-6.784-5.054-5.857-9.216.927-4.162 5.05-6.787 9.216-5.857 50.722 11.302 84.422 36.5 103.761 55.648 21.095 20.887 30.105 39.107 30.478 39.872 1.869 3.833.277 8.455-3.556 10.324-1.091.533-2.244.784-3.38.784z" fill="#0bb494" id="path49327" style="opacity:1;fill:#f45b69;fill-opacity:1;stroke-width:258.859"/><path d="m308.106 254.226c-.035.0-.068.0-.103-.001-4.254-.056-7.66-3.541-7.62-7.792.0-.459-.233-27.156-22.522-73.746-1.84-3.847-.214-8.457 3.633-10.298s8.457-.214 10.298 3.633c24.143 50.465 24.049 79.377 24.033 80.583-.056 4.231-3.502 7.621-7.719 7.621z" fill="#0bb494" id="path49329" style="opacity:1;fill:#f45b69;fill-opacity:1;stroke-width:258.859"/><g fill="#6fd7a3" id="g49339" style="display:inline;stroke-width:258.859"><path d="m293.41 353.127c-2.935.0-5.74-1.682-7.034-4.528-1.765-3.882-.048-8.459 3.834-10.224 6.955-3.161 18.792-10.715 18.911-10.791 3.592-2.297 8.368-1.248 10.665 2.345s1.248 8.367-2.345 10.665c-.522.334-12.881 8.222-20.84 11.839-1.036.47-2.122.694-3.191.694z" id="path49331" style="fill:#7f2430;fill-opacity:.992157;stroke-width:37.9613"/><path d="m308.098 407.232c-4.104.0-7.52-3.231-7.707-7.372-.193-4.26 3.104-7.87 7.364-8.063l20.207-.915c4.259-.189 7.87 3.104 8.063 7.364s-3.104 7.87-7.364 8.063l-20.207.915c-.119.005-.238.008-.356.008z" id="path49333" style="fill:#7f2430;fill-opacity:.992157;stroke-width:37.9613"/><path d="m310.641 470.991c-1.381.0-2.779-.37-4.042-1.148l-14.183-8.736c-3.631-2.236-4.762-6.993-2.525-10.623 2.236-3.632 6.993-4.762 10.623-2.525l14.184 8.736c3.631 2.236 4.762 6.993 2.525 10.623-1.459 2.368-3.99 3.673-6.582 3.673z" id="path49335" style="fill:#7f2430;fill-opacity:.992157;stroke-width:37.9613"/><path d="m258.788 512c-2.901.0-5.679-1.642-6.994-4.441l-7.245-15.427c-1.813-3.86-.153-8.458 3.707-10.271 3.858-1.813 8.458-.153 10.271 3.707l7.245 15.427c1.813 3.86.153 8.458-3.707 10.271-1.06.498-2.177.734-3.277.734z" id="path49337" style="fill:#7f2430;fill-opacity:.992157;stroke-width:37.9613"/></g></g></g></svg></a><div id=navbarNav class="offcanvas offcanvas-end bg-dark"><div class="offcanvas-header border-bottom border-light"><h5 class="offcanvas-title text-white">Menu</h5><button type=button class="btn-close btn-close-white" data-bs-dismiss=offcanvas aria-label=Close></button></div><div class=offcanvas-body><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class=nav-item><a href=https://obfuscator.re//omvll class="nav-link text-gradient-omvll"><strong>O-MVLL</strong></a></li><li class=nav-item><a href=https://obfuscator.re//dprotect class="nav-link text-gradient-dprotect"><strong>dProtect</strong></a></li><li class=nav-item><a href=/challenges/ class=nav-link>Challenges</a></li><li class=nav-item><a href=/resources/ class=nav-link>Resources</a></li><li class=nav-item><a href=https://obfuscator.re/#faq class=nav-link>FAQ</a></li></ul></div></div><button type=button class="navbar-toggler d-block d-lg-none ms-auto me-4" data-bs-toggle=offcanvas data-bs-target=#navbarNav aria-controls=navbarNav aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button></div></header><section class="container pb-5 mb-md-2 mb-lg-4" style=padding-top:9rem!important><h2 id=writeup-for-obfuscatorre-challenge-1>Writeup for obfuscator.re Challenge 1</h2><p>Author: Robert Xiao <a href=mailto:nneonneo@gmail.com>nneonneo@gmail.com</a></p><p>We&rsquo;re provided an APK file, and told that it has been protected by O-MVLL (native code), dProtect (dex code), ELF format modifications, and runtime application self protection (RASP). Let&rsquo;s dive in!</p><p>Our first stop is to unzip the APK. There&rsquo;s a single native library, <code>lib/arm64-v8a/liba1re03.so</code> weighing in at 27MB, along with bits of Kotlin data suggesting that parts of the app are written in Kotlin.</p><p>I didn&rsquo;t bother to install or run this app in any way; most of my reversing is done statically.</p><h3 id=javakotlin-code>Java/Kotlin code</h3><p>We can use JADX to inspect the Dalvik (dex) code and the AndroidManifest.xml. The code decompiles mostly fine (no bytecode-level tampering), but class and method names are obfuscated (as expected) and strings and numbers are encrypted.</p><p>There&rsquo;s a ton of obfuscated classes in the anonymous package, most of which seem to correspond to bits of Kotlin code. Luckily, the really interesting stuff is all in the <code>re.obfuscator.challenge01</code> package.</p><p>From AndroidManifest.xml, we see that the main application class is <code>re.obfuscator.challenge01.AHGILuuQdMj</code> and the main activity is <code>re.obfuscator.challenge01.sTxUFmGsNP</code>; we can rename them to <code>MainApplication</code> and <code>MainActivity</code> respectively. From <code>res/navigation/nav_graph.xml</code>, we see that <code>re.obfuscator.challenge01.XBuUyhhspa</code> corresponds to <code>FirstFragment</code>, <code>re.obfuscator.challenge01.LvfvlwOEfOn</code> to <code>SecondFragment</code>, and <code>re.obfuscator.challenge01.VCyPLJeiyfu</code> to <code>Validate</code>; we can rename these accordingly.</p><p><code>Validate</code> (<code>VCyPLJeiyfu</code>) contains the only native method, <code>public final native boolean PGPyIMEWUxFr(String str);</code>. We see that it is called as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>validate.<span style=color:#50fa7b>aLO</span>().<span style=color:#50fa7b>aLB</span>().<span style=color:#50fa7b>mo1567aj</span>(validate.<span style=color:#50fa7b>aLN</span>().<span style=color:#50fa7b>etC</span>.<span style=color:#50fa7b>getText</span>().<span style=color:#50fa7b>toString</span>());
</span></span><span style=display:flex><span>validate.<span style=color:#50fa7b>aLO</span>().<span style=color:#50fa7b>aLC</span>().<span style=color:#50fa7b>mo1567aj</span>(Boolean.<span style=color:#50fa7b>valueOf</span>(validate.<span style=color:#50fa7b>PGPyIMEWUxFr</span>(validate.<span style=color:#50fa7b>aLO</span>().<span style=color:#50fa7b>aLE</span>())));
</span></span></code></pre></div><p><code>aLE</code> appears to gather some values, presumably the login and password, and then creates a <code>cfb</code> object:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>return</span> m13766a.<span style=color:#50fa7b>m13833bf</span>(<span style=color:#ff79c6>new</span> cfb(str, value3, ((<span style=color:#8be9fd>int</span>) esT<span style=color:#ff79c6>[</span>0<span style=color:#ff79c6>]</span>) <span style=color:#ff79c6>^</span> 2122205795));
</span></span></code></pre></div><p>There&rsquo;s only one other reference to <code>cfb</code> in the code, in the function <code>List&lt;String> yakKojVORPA.toJson(cfb cfbVar)</code>. It calls <code>cev.m6193dh</code> on each of the <code>cfb</code> data elements, which in turn calls <code>Base64.encodeToString</code>. So, we can guess that the login and password are base64-encoded, put into a list and JSON-encoded, and then fed to the native function to validate the input. Knowing the input, we can now turn our attention to the native code.</p><h3 id=native-code>Native code</h3><p><code>liba1re03.so</code> is quite large. Since we suspect the ELF headers have been tampered with, the first step is to fix them using a little script I wrote: <a href=https://github.com/nneonneo/pwn-stuff/blob/master/rev/rebuild_elf_sections.py><code>rebuild_elf_sections.py</code></a>. This script basically builds brand-new ELF section headers based on the result of parsing the segment headers and DYNAMIC segment.</p><p>The resulting binary loads just fine into Ghidra. We see a ton of garbage function references - these are the &ldquo;fake exports&rdquo; mentioned in the poor man&rsquo;s obfuscator talk. It&rsquo;s easy to just delete them in Ghidra - the fake symbols are all at odd addresses, which is impossible for AARCH64.</p><p>There are two relevant bits of code: the initialization functions from <code>.init_array</code>, called when the library is loaded, and the <code>JNI_OnLoad</code> function, called from <code>System.loadLibrary</code> in Java.</p><p>There are a total of 13 <code>init_array</code> functions, which I named <code>init_0</code> through <code>init_12</code>. At a glance, <code>init_0</code> through <code>init_8</code> (except <code>init_5</code>) are just performing string decryption. <code>init_5</code> is more complex; Ghidra decompiles it as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>init_5</span>(<span style=color:#8be9fd>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  undefined <span style=color:#ff79c6>*</span>puVar1;
</span></span><span style=display:flex><span>  ulong uVar2;
</span></span><span style=display:flex><span>  <span style=color:#8be9fd>long</span> lVar3;
</span></span><span style=display:flex><span>  undefined <span style=color:#ff79c6>*</span>puVar4;
</span></span><span style=display:flex><span>  ulong uVar5;
</span></span><span style=display:flex><span>  ulong uVar6;
</span></span><span style=display:flex><span>  undefined auStack_40 [<span style=color:#bd93f9>16</span>];
</span></span><span style=display:flex><span>  undefined <span style=color:#ff79c6>*</span>local_30;
</span></span><span style=display:flex><span>  code <span style=color:#ff79c6>*</span>local_28;
</span></span><span style=display:flex><span>  undefined8 <span style=color:#ff79c6>****</span>local_20 [<span style=color:#bd93f9>2</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  local_20[<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>=</span> local_20 <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>  local_30 <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>DAT_00308cc4;
</span></span><span style=display:flex><span>  uVar6 <span style=color:#ff79c6>=</span> (ulong)local_20[<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>|</span> (ulong)local_20;
</span></span><span style=display:flex><span>  uVar2 <span style=color:#ff79c6>=</span> ((ulong)local_20[<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>&amp;</span> (ulong)local_20) <span style=color:#ff79c6>+</span> uVar6;
</span></span><span style=display:flex><span>  uVar5 <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>long</span>)local_20[<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>+</span> (<span style=color:#8be9fd>long</span>)local_20;
</span></span><span style=display:flex><span>  uVar6 <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>~</span>uVar5 <span style=color:#ff79c6>+</span> uVar6;
</span></span><span style=display:flex><span>  uVar6 <span style=color:#ff79c6>=</span> ((uVar2 <span style=color:#ff79c6>|</span> <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>&amp;</span> uVar6) <span style=color:#ff79c6>+</span> (uVar2 <span style=color:#ff79c6>|</span> <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>|</span> uVar6);
</span></span><span style=display:flex><span>  uVar5 <span style=color:#ff79c6>+=</span> <span style=color:#ff79c6>~</span>(ulong)local_20[<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>|</span> (ulong)local_20 <span style=color:#ff79c6>^</span> <span style=color:#bd93f9>0xffffffffffffffff</span>;
</span></span><span style=display:flex><span>  lVar3 <span style=color:#ff79c6>=</span> (uVar5 <span style=color:#ff79c6>^</span> uVar2 <span style=color:#ff79c6>^</span> <span style=color:#bd93f9>0xffffffffffffffff</span>) <span style=color:#ff79c6>+</span> (uVar2 <span style=color:#ff79c6>&amp;</span> (uVar5 <span style=color:#ff79c6>^</span> <span style=color:#bd93f9>0xffffffffffffffff</span>)) <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>2</span>;
</span></span><span style=display:flex><span>  uVar2 <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>-</span>lVar3;
</span></span><span style=display:flex><span>  uVar5 <span style=color:#ff79c6>=</span> uVar6 <span style=color:#ff79c6>|</span> uVar2;
</span></span><span style=display:flex><span>  uVar2 <span style=color:#ff79c6>=</span> uVar5 <span style=color:#ff79c6>-</span> (uVar6 <span style=color:#ff79c6>&amp;</span> uVar2);
</span></span><span style=display:flex><span>  lVar3 <span style=color:#ff79c6>=</span> (uVar6 <span style=color:#ff79c6>-</span> lVar3) <span style=color:#ff79c6>-</span> uVar5;
</span></span><span style=display:flex><span>  uVar2 <span style=color:#ff79c6>=</span> ((uVar2 <span style=color:#ff79c6>&amp;</span> lVar3 <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>2</span>) <span style=color:#ff79c6>+</span> (uVar2 <span style=color:#ff79c6>|</span> lVar3 <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>2</span>)) <span style=color:#ff79c6>-</span> ((ulong)local_20[<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>^</span> (ulong)local_20);
</span></span><span style=display:flex><span>  puVar4 <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>DAT_00308cc4 <span style=color:#ff79c6>+</span> (uVar2 <span style=color:#ff79c6>-</span> (uVar2 <span style=color:#ff79c6>|</span> <span style=color:#bd93f9>0x308cc4</span>));
</span></span><span style=display:flex><span>  puVar1 <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>DAT_00308cc4 <span style=color:#ff79c6>+</span> (uVar2 <span style=color:#ff79c6>^</span> <span style=color:#bd93f9>0xffffffffffffffff</span> <span style=color:#ff79c6>|</span> <span style=color:#bd93f9>0xffffffffffcf733b</span>) <span style=color:#ff79c6>+</span> uVar2 <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>  uVar2 <span style=color:#ff79c6>=</span> ((ulong)puVar4 <span style=color:#ff79c6>&amp;</span> (ulong)puVar1) <span style=color:#ff79c6>+</span> ((ulong)puVar4 <span style=color:#ff79c6>|</span> (ulong)puVar1);
</span></span><span style=display:flex><span>  DAT_019f60c8 <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0x12</span>;
</span></span><span style=display:flex><span>  local_20[<span style=color:#bd93f9>1</span>] <span style=color:#ff79c6>=</span> (undefined8 <span style=color:#ff79c6>****</span>)<span style=color:#bd93f9>0xe</span>;
</span></span><span style=display:flex><span>  uVar6 <span style=color:#ff79c6>=</span> (uVar2 <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>0x20</span>) <span style=color:#ff79c6>-</span> (uVar2 <span style=color:#ff79c6>|</span> <span style=color:#bd93f9>0x20</span>);
</span></span><span style=display:flex><span>  uVar2 <span style=color:#ff79c6>=</span> uVar2 <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>0x20</span> <span style=color:#ff79c6>+</span> (<span style=color:#ff79c6>~</span>uVar2 <span style=color:#ff79c6>|</span> <span style=color:#bd93f9>0xffffffffffffffdf</span>) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>  local_28 <span style=color:#ff79c6>=</span> (code <span style=color:#ff79c6>*</span>)((uVar6 <span style=color:#ff79c6>&amp;</span> uVar2) <span style=color:#ff79c6>+</span> (uVar6 <span style=color:#ff79c6>|</span> uVar2));
</span></span><span style=display:flex><span>  (<span style=color:#ff79c6>*</span>local_28)();
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><br><p>I recognize this as the <a href=https://obfuscator.re/omvll/passes/control-flow-breaking/>control-flow breaking</a> pass from O-MVLL: this is a wrapper which uses opaque constants derived from the stack pointer to obfuscate the real address of the function (called at the end via <code>local_28</code>). The code uses the low bits of <code>sp</code>, which are always zero due to stack alignment, resulting in a constant result. However, since the decompiler does not make this assumption, it outputs the raw (obfuscated) calculations.</p><p>Luckily, I have a trick: using <code>Set Register Values...</code> in Ghidra, we can just set <code>sp</code> to a concrete value (say, 0x7fff000b0000) at the start of the function, and Ghidra&rsquo;s constant propagation will do the rest:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#6272a4>// WARNING: This function may have set the stack pointer
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>init_5</span>(<span style=color:#8be9fd>void</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  undefined8 unaff_x30;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  uRam00007fff000affe0 <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0x7fff000affe8</span>;
</span></span><span style=display:flex><span>  puRam00007fff000affd0 <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>&amp;</span>DAT_00308cc4;
</span></span><span style=display:flex><span>  DAT_019f60c8 <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0x12</span>;
</span></span><span style=display:flex><span>  uRam00007fff000affe8 <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0xe</span>;
</span></span><span style=display:flex><span>  pcRam00007fff000affd8 <span style=color:#ff79c6>=</span> FUN_00308ce4;
</span></span><span style=display:flex><span>  uRam00007fff000afff0 <span style=color:#ff79c6>=</span> unaff_x30;
</span></span><span style=display:flex><span>  <span style=color:#50fa7b>FUN_00308ce4</span>();
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><br><p>Note that I also added 0x7fff&mldr; to the memory map (Window -> Memory Map) so that stack references would still work. Now, it&rsquo;s trivial to identify the real function (<code>FUN_00308ce4</code>) and decompile it to find another string decryption routine.</p><p>We can use emulation to recover the decrypted strings. I wrote a little script that uses the Unicorn engine to call functions from the binary. Note that Ghidra loads using a base address of 0x100000, but I don&rsquo;t want to handle relocations, so I just load at address 0:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>from</span> unicorn <span style=color:#ff79c6>import</span> <span style=color:#ff79c6>*</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> unicorn.arm64_const <span style=color:#ff79c6>import</span> <span style=color:#ff79c6>*</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> lief
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>uc <span style=color:#ff79c6>=</span> Uc(UC_ARCH_ARM64, UC_MODE_ARM)
</span></span><span style=display:flex><span>STACK_TOP <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0x7fff_ffff_0000</span>
</span></span><span style=display:flex><span>END_ADDR <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0xffff_ffff_ffff_f000</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># stack</span>
</span></span><span style=display:flex><span>uc<span style=color:#ff79c6>.</span>mem_map(STACK_TOP <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>0x100000</span>, <span style=color:#bd93f9>0x101000</span>, UC_PROT_READ<span style=color:#ff79c6>|</span>UC_PROT_WRITE)
</span></span><span style=display:flex><span><span style=color:#6272a4># return page</span>
</span></span><span style=display:flex><span>uc<span style=color:#ff79c6>.</span>mem_map(END_ADDR, <span style=color:#bd93f9>0x1000</span>, UC_PROT_EXEC)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>align_down</span>(addr: <span style=color:#8be9fd;font-style:italic>int</span>, align: <span style=color:#8be9fd;font-style:italic>int</span> <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>4096</span>) <span style=color:#ff79c6>-&gt;</span> <span style=color:#8be9fd;font-style:italic>int</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> addr <span style=color:#ff79c6>//</span> align <span style=color:#ff79c6>*</span> align
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>align_up</span>(addr: <span style=color:#8be9fd;font-style:italic>int</span>, align: <span style=color:#8be9fd;font-style:italic>int</span> <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>4096</span>) <span style=color:#ff79c6>-&gt;</span> <span style=color:#8be9fd;font-style:italic>int</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> (addr <span style=color:#ff79c6>+</span> align <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>//</span> align <span style=color:#ff79c6>*</span> align
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>elf_prot_to_uc</span>(prot: lief<span style=color:#ff79c6>.</span>ELF<span style=color:#ff79c6>.</span>SEGMENT_FLAGS) <span style=color:#ff79c6>-&gt;</span> <span style=color:#8be9fd;font-style:italic>int</span>:
</span></span><span style=display:flex><span>    res <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> prot <span style=color:#ff79c6>&amp;</span> lief<span style=color:#ff79c6>.</span>ELF<span style=color:#ff79c6>.</span>SEGMENT_FLAGS<span style=color:#ff79c6>.</span>R:
</span></span><span style=display:flex><span>        res <span style=color:#ff79c6>|=</span> UC_PROT_READ
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> prot <span style=color:#ff79c6>&amp;</span> lief<span style=color:#ff79c6>.</span>ELF<span style=color:#ff79c6>.</span>SEGMENT_FLAGS<span style=color:#ff79c6>.</span>W:
</span></span><span style=display:flex><span>        res <span style=color:#ff79c6>|=</span> UC_PROT_WRITE
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> prot <span style=color:#ff79c6>&amp;</span> lief<span style=color:#ff79c6>.</span>ELF<span style=color:#ff79c6>.</span>SEGMENT_FLAGS<span style=color:#ff79c6>.</span>X:
</span></span><span style=display:flex><span>        res <span style=color:#ff79c6>|=</span> UC_PROT_EXEC
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> res
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>load_elf</span>(uc, filename):
</span></span><span style=display:flex><span>    f <span style=color:#ff79c6>=</span> lief<span style=color:#ff79c6>.</span>parse(filename)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> seg <span style=color:#ff79c6>in</span> f<span style=color:#ff79c6>.</span>segments:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> seg<span style=color:#ff79c6>.</span>type <span style=color:#ff79c6>==</span> lief<span style=color:#ff79c6>.</span>ELF<span style=color:#ff79c6>.</span>SEGMENT_TYPES<span style=color:#ff79c6>.</span>LOAD:
</span></span><span style=display:flex><span>            page_start <span style=color:#ff79c6>=</span> align_down(seg<span style=color:#ff79c6>.</span>virtual_address)
</span></span><span style=display:flex><span>            page_end <span style=color:#ff79c6>=</span> align_up(seg<span style=color:#ff79c6>.</span>virtual_address <span style=color:#ff79c6>+</span> seg<span style=color:#ff79c6>.</span>virtual_size)
</span></span><span style=display:flex><span>            uc<span style=color:#ff79c6>.</span>mem_map(page_start, page_end <span style=color:#ff79c6>-</span> page_start, elf_prot_to_uc(seg<span style=color:#ff79c6>.</span>flags))
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> seg<span style=color:#ff79c6>.</span>content:
</span></span><span style=display:flex><span>                uc<span style=color:#ff79c6>.</span>mem_write(seg<span style=color:#ff79c6>.</span>virtual_address, <span style=color:#8be9fd;font-style:italic>bytes</span>(seg<span style=color:#ff79c6>.</span>content))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>call_func</span>(uc, addr):
</span></span><span style=display:flex><span>    uc<span style=color:#ff79c6>.</span>reg_write(UC_ARM64_REG_SP, STACK_TOP)
</span></span><span style=display:flex><span>    uc<span style=color:#ff79c6>.</span>reg_write(UC_ARM64_REG_LR, END_ADDR)
</span></span><span style=display:flex><span>    uc<span style=color:#ff79c6>.</span>emu_start(addr, END_ADDR)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>rreg</span>(name):
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> uc<span style=color:#ff79c6>.</span>reg_read(<span style=color:#8be9fd;font-style:italic>globals</span>()[<span style=color:#f1fa8c>&#34;UC_ARM64_REG_&#34;</span> <span style=color:#ff79c6>+</span> name<span style=color:#ff79c6>.</span>upper()])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>rstr</span>(addr):
</span></span><span style=display:flex><span>    res <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>bytearray</span>()
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>while</span> <span style=color:#bd93f9>1</span>:
</span></span><span style=display:flex><span>        b <span style=color:#ff79c6>=</span> uc<span style=color:#ff79c6>.</span>mem_read(addr, <span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> b <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\x00</span><span style=color:#f1fa8c>&#34;</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>break</span>
</span></span><span style=display:flex><span>        res <span style=color:#ff79c6>+=</span> b
</span></span><span style=display:flex><span>        addr <span style=color:#ff79c6>+=</span> <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> res
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>load_elf(uc, <span style=color:#f1fa8c>&#34;liba1re03.so&#34;</span>)
</span></span><span style=display:flex><span>call_func(uc, <span style=color:#bd93f9>0x1c2004</span>)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(uc<span style=color:#ff79c6>.</span>mem_read(<span style=color:#bd93f9>0x4481f0</span>, <span style=color:#bd93f9>9</span>))
</span></span><span style=display:flex><span>call_func(uc, <span style=color:#bd93f9>0x1cda30</span>)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(uc<span style=color:#ff79c6>.</span>mem_read(<span style=color:#bd93f9>0x4481f9</span>, <span style=color:#bd93f9>9</span>))
</span></span><span style=display:flex><span>call_func(uc, <span style=color:#bd93f9>0x1cdc70</span>)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(uc<span style=color:#ff79c6>.</span>mem_read(<span style=color:#bd93f9>0x448201</span>, <span style=color:#bd93f9>0x50d</span>))
</span></span><span style=display:flex><span>call_func(uc, <span style=color:#bd93f9>0x1cd628</span>)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(uc<span style=color:#ff79c6>.</span>mem_read(<span style=color:#bd93f9>0x44870e</span>, <span style=color:#bd93f9>7</span>))
</span></span><span style=display:flex><span>call_func(uc, <span style=color:#bd93f9>0x1de9d4</span>)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(uc<span style=color:#ff79c6>.</span>mem_read(<span style=color:#bd93f9>0x448778</span>, <span style=color:#bd93f9>0x212</span>))
</span></span><span style=display:flex><span>call_func(uc, <span style=color:#bd93f9>0x2021a4</span>)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(uc<span style=color:#ff79c6>.</span>mem_read(<span style=color:#bd93f9>0x44898a</span>, <span style=color:#bd93f9>16</span>))
</span></span><span style=display:flex><span>call_func(uc, <span style=color:#bd93f9>0x202720</span>)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(uc<span style=color:#ff79c6>.</span>mem_read(<span style=color:#bd93f9>0x44899a</span>, <span style=color:#bd93f9>0x1a</span>))
</span></span><span style=display:flex><span>call_func(uc, <span style=color:#bd93f9>0x201540</span>)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(uc<span style=color:#ff79c6>.</span>mem_read(<span style=color:#bd93f9>0x4489b4</span>, <span style=color:#bd93f9>8</span>))
</span></span><span style=display:flex><span>call_func(uc, <span style=color:#bd93f9>0x1ff984</span>)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(uc<span style=color:#ff79c6>.</span>mem_read(<span style=color:#bd93f9>0x4489bc</span>, <span style=color:#bd93f9>0x1a</span>))
</span></span></code></pre></div><br><p>This gives us the following strings:</p><pre tabindex=0><code>bytearray(b&#39;__FLAG__\x00&#39;)
bytearray(b&#39;__doc__\x00\x9b&#39;)
bytearray(b&#39;\n    700d0d0a000000004aaf626335010000e300000000000000000000000000000000040000004\n    00000007338000000640064016d005a00640064016d015a0164026502640365036604640464\n    0583045a04640265026403650366046406640783045a05640153002908e9000000004eda046\n    4617461da0672657475726e6301000000000000000000000003000000040000004300000073\n    3a0000007400a1017d00a2015c027c017c027402a1037d01a2017c017402a1037d02a2017c0\n    27402a1047d017d021800a201a105a20074026a066b02530029014e2907da046a736f6eda05\n    6c6f616473da07616e64726f6964da066465636f6465da0e5f5f6f6266757363617465645f5\n    fda03686578da075f5f646f635f5f290372020000005a056c6f67696eda0870617373776f72\n    64a900720c000000fa502f686f6d652f726f6d61696e2f6465762f6f70656e2d6f626675736\n    361746f722f6368616c6c656e67652f6368616c6c656e67652d30312f736372697074732f65\n    787472612f636865636b65722e7079da05636865636b0400000073080000000e010a010a011\n    801720e00000063010000000000000000000000010000000200000043000000730c00000074\n    007d00840164016b02530029024e72010000002901da036c656e29017202000000720c00000\n    0720c000000720d000000da067665726966790a00000073020000000c017210000000290672\n    060000007204000000da03737472da04626f6f6c720e0000007210000000720c000000720c0\n    00000720c000000720d000000da083c6d6f64756c653e010000007308000000080008011202\n    1606\n  \x00&#39;)
bytearray(b&#39;__bc__\x00&#39;)
bytearray(b&#39;\n      import android\n      from android import decode, hash\n      import json\n      data = json.loads(json_data)\n      login, password = data\n\n      login    = decode(login)\n      password = decode(password)\n\n      flag = login + password\n      h = hash(flag).hex()\n      if h != android.__FLAG__:\n        android.print(&#34;Humm it looks like, it\&#39;s not the good flag ...&#34;)\n        android.print(&#34;It should be {} while it is {}&#34;.format(android.__FLAG__, h))\n      else:\n        android.print(&#34;Well done!&#34;)\n        is_valid = True\n  \x00&#39;)
bytearray(b&#39;/proc/self/task\x00&#39;)
bytearray(b&#39;/proc/self/task/{}/status\x00&#39;)
bytearray(b&#39;libc.so\x00&#39;)
bytearray(b&#39;__system_property_foreach\x00&#39;)
</code></pre><br><p>Looks like Python code! This would explain why the binary is so huge. Let&rsquo;s take a detour to look at the Python bits&mldr;</p><h3 id=embedded-python-bits>Embedded Python bits</h3><p>A Python interpreter means the Python stdlib must be present. Since there&rsquo;s no Python stuff in the APK, the stdlib is probably packed in the binary. Indeed, at offset 0x4469E0, we can find a ZIP header (<code>PK\3\4</code>). Extracting this, we get a 21.5 MB ZIP file containing the entire Python 3.10 standard library. We also get a few extra files of interest:</p><ul><li><code>_sysconfigdata__linux_aarch64-linux-android.py</code>: shows the full configuration of the build, including file paths</li><li><code>pyloader.py</code>: not part of the Python standard lib, contains the following code:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>import</span> importlib
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> importlib.machinery <span style=color:#ff79c6>import</span> SourcelessFileLoader
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> importlib.util <span style=color:#ff79c6>import</span> spec_from_file_location
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> sys
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> android
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>FileLoader</span>(SourcelessFileLoader):
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>def</span> __init__(self):
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>super</span>()<span style=color:#ff79c6>.</span>__init__(<span style=color:#f1fa8c>&#34;checker&#34;</span>, <span style=color:#f1fa8c>&#34;checker.cpython-310.pyc&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>get_data</span>(self, path: <span style=color:#8be9fd;font-style:italic>str</span>):
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>bytes</span><span style=color:#ff79c6>.</span>fromhex(android<span style=color:#ff79c6>.</span>__bc__<span style=color:#ff79c6>.</span>replace(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, <span style=color:#f1fa8c>&#34;&#34;</span>)<span style=color:#ff79c6>.</span>strip()<span style=color:#ff79c6>.</span>replace(<span style=color:#f1fa8c>&#34; &#34;</span>, <span style=color:#f1fa8c>&#34;&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>import_checker</span>():
</span></span><span style=display:flex><span>    loader <span style=color:#ff79c6>=</span> FileLoader()
</span></span><span style=display:flex><span>    spec <span style=color:#ff79c6>=</span> spec_from_file_location(<span style=color:#f1fa8c>&#39;checker&#39;</span>, <span style=color:#f1fa8c>&#34;checker.cpython-310.pyc&#34;</span>,
</span></span><span style=display:flex><span>                                    loader<span style=color:#ff79c6>=</span>loader)
</span></span><span style=display:flex><span>    module <span style=color:#ff79c6>=</span> importlib<span style=color:#ff79c6>.</span>_bootstrap<span style=color:#ff79c6>.</span>_load(spec)
</span></span><span style=display:flex><span>    sys<span style=color:#ff79c6>.</span>modules[<span style=color:#f1fa8c>&#39;checker&#39;</span>] <span style=color:#ff79c6>=</span> module
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> module
</span></span></code></pre></div><br><ul><li><code>config-3.10</code>: a directory containing lots of Python build artifacts, including <code>config.c</code>, <code>Makefile</code>, <code>Setup</code>, <code>libpython3.10.a</code> and <code>python.o</code>.</li></ul><p>The inclusion of <code>config-3.10</code> is strange, and very pointless: <code>libpython3.10.a</code> is <em>huge</em> (23.6 MB) and completely unnecessary at runtime, plus it contains symbols for the entire Python standard library. We can take advantage of it: by compiling <code>python.o</code> with <code>libpython3.10.a</code>, we get a binary with all of the Python symbols:</p><p><code>aarch64-linux-android-gcc python.o -l python3.10 -o python.elf --sysroot=${NDK_HOME}/platforms/android-24/arch-arm64 -L. -lm</code></p><p>I loaded this binary into Ghidra, then used the Version Tracker (a bindiff-like tool) to apply all of the symbols to <code>liba1re03.so</code>, thereby allowing me to see proper symbols for pretty much the entire Python interpreter. I also imported all of the data types from the libpython DWARF.</p><p><code>pyloader.py</code> is also pretty interesting. It suggests that the real checker function is loaded from the <code>__bc__</code> constant, which is referred to in our decrypted strings above. We&rsquo;ll revisit this soon.</p><h3 id=returning-to-the-native-binary>Returning to the native binary</h3><p><code>init_9</code> looks like it&rsquo;s setting up some kind of thread, maybe a security mechanism. I ignored it. <code>init_10</code> just calls <code>__cxa_atexit</code>, and <code>init_12</code> is checking to see if the CPU has LSE atomics (<code>__aarch64_have_lse_atomics</code>).</p><p><code>init_11</code> is more interesting. From the strings it uses and our recovered Python interpreter symbols, we can see that it&rsquo;s defining a <code>pybind11</code> extension module named <code>android</code>. The main function is <code>FUN_002c35d8</code>; this is a long function with a lot of inlined string decryption junk. Again, I chose to just run this in Unicorn, after working out what functions it calls:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#6272a4># pybind11_init_android</span>
</span></span><span style=display:flex><span>uc<span style=color:#ff79c6>.</span>reg_write(UC_ARM64_REG_SP, STACK_TOP)
</span></span><span style=display:flex><span>uc<span style=color:#ff79c6>.</span>reg_write(UC_ARM64_REG_LR, END_ADDR)
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>hook_code</span>(uc, addr, sz, userdata):
</span></span><span style=display:flex><span>    pc <span style=color:#ff79c6>=</span> uc<span style=color:#ff79c6>.</span>reg_read(UC_ARM64_REG_PC)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>not</span> <span style=color:#bd93f9>0x1c35d8</span> <span style=color:#ff79c6>&lt;=</span> pc <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0x1cd318</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> pc <span style=color:#ff79c6>==</span> END_ADDR:
</span></span><span style=display:flex><span>            uc<span style=color:#ff79c6>.</span>emu_stop()
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>elif</span> pc <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0x164888</span>:
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;str(</span><span style=color:#f1fa8c>{</span>rreg(<span style=color:#f1fa8c>&#39;x0&#39;</span>)<span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>#x</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>, </span><span style=color:#f1fa8c>{</span>rstr(rreg(<span style=color:#f1fa8c>&#39;x1&#39;</span>))<span style=color:#ff79c6>.</span>decode()<span style=color:#f1fa8c>!r}</span><span style=color:#f1fa8c>)&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>elif</span> pc <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0x180c08</span>:
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;str_attr_accessor(</span><span style=color:#f1fa8c>{</span>rreg(<span style=color:#f1fa8c>&#39;x8&#39;</span>)<span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>#x</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>, </span><span style=color:#f1fa8c>{</span>rreg(<span style=color:#f1fa8c>&#39;x0&#39;</span>)<span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>#x</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>, </span><span style=color:#f1fa8c>{</span>rstr(rreg(<span style=color:#f1fa8c>&#39;x1&#39;</span>))<span style=color:#ff79c6>.</span>decode()<span style=color:#f1fa8c>!r}</span><span style=color:#f1fa8c>)&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>elif</span> pc <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0x1bfa48</span>:
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;str_attr_accessor::=(</span><span style=color:#f1fa8c>{</span>rreg(<span style=color:#f1fa8c>&#39;x0&#39;</span>)<span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>#x</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>, </span><span style=color:#f1fa8c>{</span>rreg(<span style=color:#f1fa8c>&#39;x1&#39;</span>)<span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>#x</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>)&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>elif</span> pc <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0x1a6e18</span>:
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;~str_attr_accessor(</span><span style=color:#f1fa8c>{</span>rreg(<span style=color:#f1fa8c>&#39;x0&#39;</span>)<span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>#x</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>)&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>elif</span> pc <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0x1ab018</span>:
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;~str(</span><span style=color:#f1fa8c>{</span>rreg(<span style=color:#f1fa8c>&#39;x0&#39;</span>)<span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>#x</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>)&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>elif</span> pc <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0x1c22b0</span>:
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;0x1c22b0(</span><span style=color:#f1fa8c>{</span>rreg(<span style=color:#f1fa8c>&#39;x0&#39;</span>)<span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>#x</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>, </span><span style=color:#f1fa8c>{</span>rstr(rreg(<span style=color:#f1fa8c>&#39;x1&#39;</span>))<span style=color:#ff79c6>.</span>decode()<span style=color:#f1fa8c>!r}</span><span style=color:#f1fa8c>, </span><span style=color:#f1fa8c>{</span>rreg(<span style=color:#f1fa8c>&#39;x2&#39;</span>)<span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>#x</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>)&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>elif</span> pc <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0x1c2438</span>:
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;0x1c2438(</span><span style=color:#f1fa8c>{</span>rreg(<span style=color:#f1fa8c>&#39;x0&#39;</span>)<span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>#x</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>, </span><span style=color:#f1fa8c>{</span>rstr(rreg(<span style=color:#f1fa8c>&#39;x1&#39;</span>))<span style=color:#ff79c6>.</span>decode()<span style=color:#f1fa8c>!r}</span><span style=color:#f1fa8c>, </span><span style=color:#f1fa8c>{</span>rreg(<span style=color:#f1fa8c>&#39;x2&#39;</span>)<span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>#x</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>)&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>elif</span> pc <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0x1c316c</span>:
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;0x1c316c(</span><span style=color:#f1fa8c>{</span>rreg(<span style=color:#f1fa8c>&#39;x0&#39;</span>)<span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>#x</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>, </span><span style=color:#f1fa8c>{</span>rstr(rreg(<span style=color:#f1fa8c>&#39;x1&#39;</span>))<span style=color:#ff79c6>.</span>decode()<span style=color:#f1fa8c>!r}</span><span style=color:#f1fa8c>, </span><span style=color:#f1fa8c>{</span>rreg(<span style=color:#f1fa8c>&#39;x2&#39;</span>)<span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>#x</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>)&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>elif</span> pc <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0x1c2730</span>:
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;0x1c2730(</span><span style=color:#f1fa8c>{</span>rreg(<span style=color:#f1fa8c>&#39;x0&#39;</span>)<span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>#x</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>, </span><span style=color:#f1fa8c>{</span>rstr(rreg(<span style=color:#f1fa8c>&#39;x1&#39;</span>))<span style=color:#ff79c6>.</span>decode()<span style=color:#f1fa8c>!r}</span><span style=color:#f1fa8c>, </span><span style=color:#f1fa8c>{</span>rreg(<span style=color:#f1fa8c>&#39;x2&#39;</span>)<span style=color:#f1fa8c>:</span><span style=color:#f1fa8c>#x</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>)&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#8be9fd;font-style:italic>hex</span>(pc), <span style=color:#8be9fd;font-style:italic>hex</span>(uc<span style=color:#ff79c6>.</span>reg_read(UC_ARM64_REG_X0)), <span style=color:#8be9fd;font-style:italic>hex</span>(uc<span style=color:#ff79c6>.</span>reg_read(UC_ARM64_REG_X1)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        uc<span style=color:#ff79c6>.</span>reg_write(UC_ARM64_REG_PC, uc<span style=color:#ff79c6>.</span>reg_read(UC_ARM64_REG_LR))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>hook <span style=color:#ff79c6>=</span> uc<span style=color:#ff79c6>.</span>hook_add(UC_HOOK_CODE, hook_code, <span style=color:#ff79c6>None</span>, <span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>0xffffffff</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>uc<span style=color:#ff79c6>.</span>emu_start(<span style=color:#bd93f9>0x1c35d8</span>, <span style=color:#bd93f9>0x1cd318</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>uc<span style=color:#ff79c6>.</span>hook_del(hook)
</span></span></code></pre></div><br><p>This is quite helpful. We get lots of information:</p><pre tabindex=0><code>str(0x7ffffffefeb8, &#39;f5ca458deb9629a74d4b0c3669deb5078a6a85a90afba9a3c76f5306a4bafb06&#39;)
str_attr_accessor(0x7ffffffeff70, 0x0, &#39;__FLAG__&#39;)
str_attr_accessor::=(0x7ffffffeff70, 0x7ffffffefeb8)
~str_attr_accessor(0x7ffffffeff70)
~str(0x7ffffffefeb8)
str(0x7ffffffefeb0, &#39;9c16a9c3017d2b3876323bc4f9dad2b7530c&#39;)
str_attr_accessor(0x7ffffffeff50, 0x0, &#39;__doc__&#39;)
str_attr_accessor::=(0x7ffffffeff50, 0x7ffffffefeb0)
~str_attr_accessor(0x7ffffffeff50)
~str(0x7ffffffefeb0)
str(0x7ffffffefea8, &#39;\n    700d0d0a000000004aaf626335010000e300000000000000000000000000000000040000004\n    00000007338000000640064016d005a00640064016d015a0164026502640365036604640464\n    0583045a04640265026403650366046406640783045a05640153002908e9000000004eda046\n    4617461da0672657475726e6301000000000000000000000003000000040000004300000073\n    3a0000007400a1017d00a2015c027c017c027402a1037d01a2017c017402a1037d02a2017c0\n    27402a1047d017d021800a201a105a20074026a066b02530029014e2907da046a736f6eda05\n    6c6f616473da07616e64726f6964da066465636f6465da0e5f5f6f6266757363617465645f5\n    fda03686578da075f5f646f635f5f290372020000005a056c6f67696eda0870617373776f72\n    64a900720c000000fa502f686f6d652f726f6d61696e2f6465762f6f70656e2d6f626675736\n    361746f722f6368616c6c656e67652f6368616c6c656e67652d30312f736372697074732f65\n    787472612f636865636b65722e7079da05636865636b0400000073080000000e010a010a011\n    801720e00000063010000000000000000000000010000000200000043000000730c00000074\n    007d00840164016b02530029024e72010000002901da036c656e29017202000000720c00000\n    0720c000000720d000000da067665726966790a00000073020000000c017210000000290672\n    060000007204000000da03737472da04626f6f6c720e0000007210000000720c000000720c0\n    00000720c000000720d000000da083c6d6f64756c653e010000007308000000080008011202\n    1606\n  &#39;)
str_attr_accessor(0x7ffffffeff30, 0x0, &#39;__bc__&#39;)
str_attr_accessor::=(0x7ffffffeff30, 0x7ffffffefea8)
~str_attr_accessor(0x7ffffffeff30)
~str(0x7ffffffefea8)
0x1c22b0(0x0, &#39;print&#39;, 0x7ffffffefea0)
0x1c2438(0x0, &#39;MvtKNJXCOGJe&#39;, 0x1c32e0)
0x1c316c(0x0, &#39;decode&#39;, 0x1c2640)
0x1c2730(0x0, &#39;hash&#39;, 0x7ffffffefe98)
</code></pre><br><p>From this, we can tell what the <code>android</code> module looks like:</p><ul><li><code>__FLAG__ = "f5ca458deb9629a74d4b0c3669deb5078a6a85a90afba9a3c76f5306a4bafb06"</code></li><li><code>__doc__ = "9c16a9c3017d2b3876323bc4f9dad2b7530c"</code></li><li><code>__bc__ = "\n 700d0d0a000000004aaf626335010000e300000..."</code></li><li><code>print = ?</code></li><li><code>hash = ?</code></li><li><code>MvtKNJXCOGJe = native function at 0x1c32e0</code></li><li><code>decode = native function at 0x1c2640</code></li></ul><p>Finally, we have <code>JNI_OnLoad</code>. The function is another obfuscated wrapper, which we can fix by setting <code>sp</code>. The real <code>JNI_OnLoad</code> is obfuscated using control-flow flattening and more opaque constants; setting <code>sp</code> fixes the latter issue, and the function is pretty simple so the flattened control flow is not hard to deal with.</p><p>Tracing through the function, we see that it grabs a <code>JNIEnv</code> via the helper function at <code>FUN_0026f0d0</code>, sets up a <code>JNINativeMethod</code> structure on the stack and then calls <code>env->RegisterNatives</code> to register a single function. The function pointer is either <code>FUN_002e71a4</code> or <code>FUN_002d8428</code> depending on some thread-local flag (run-time protection again?).</p><p><code>FUN_002e71a4</code> is an obfuscated wrapper that calls <code>2d6288</code>. That calls <code>env->GetStringUTFChars</code>, <code>py::initialize_interpreter_</code> and <code>FUN_002bf3a8</code>. This latter function does some more string decryption, ultimately calling <code>pybind11::module_::import("pyloader")</code> and accessing the <code>import_checker</code> attribute: this is what kicks off the <code>pyloader.py</code> code we saw earlier.</p><h3 id=python-again>Python, again</h3><p><code>pyloader.py</code> loads a module from <code>__bc__</code>. This module won&rsquo;t decompile properly, so I decided to examine the disassembly (<code>dis.dis(marshal.loads(bytes.fromhex(__bc__.replace(" ", "").replace("\n", ""))[16:]))</code>):</p><pre tabindex=0><code>  1           0 LOAD_CONST               0 (0)
              2 LOAD_CONST               1 (None)
              4 IMPORT_FROM              0 (android)
              6 STORE_NAME               0 (android)

  2           8 LOAD_CONST               0 (0)
             10 LOAD_CONST               1 (None)
             12 IMPORT_FROM              1 (json)
             14 STORE_NAME               1 (json)

  4          16 LOAD_CONST               2 (&#39;data&#39;)
             18 LOAD_NAME                2 (str)
             20 LOAD_CONST               3 (&#39;return&#39;)
             22 LOAD_NAME                3 (bool)
             24 BUILD_TUPLE              4
             26 LOAD_CONST               4 (&lt;code object check at 0x109ae1dc0, file &#34;/home/romain/dev/open-obfuscator/challenge/challenge-01/scripts/extra/checker.py&#34;, line 4&gt;)
             28 LOAD_CONST               5 (&#39;check&#39;)
             30 CALL_FUNCTION            4
             32 STORE_NAME               4 (check)

 10          34 LOAD_CONST               2 (&#39;data&#39;)
             36 LOAD_NAME                2 (str)
             38 LOAD_CONST               3 (&#39;return&#39;)
             40 LOAD_NAME                3 (bool)
             42 BUILD_TUPLE              4
             44 LOAD_CONST               6 (&lt;code object verify at 0x109ae16e0, file &#34;/home/romain/dev/open-obfuscator/challenge/challenge-01/scripts/extra/checker.py&#34;, line 10&gt;)
             46 LOAD_CONST               7 (&#39;verify&#39;)
             48 CALL_FUNCTION            4
             50 STORE_NAME               5 (verify)
             52 LOAD_CONST               1 (None)
             54 RETURN_VALUE

Disassembly of &lt;code object check at 0x109ae1dc0, file &#34;/home/romain/dev/open-obfuscator/challenge/challenge-01/scripts/extra/checker.py&#34;, line 4&gt;:
  5           0 LOAD_GLOBAL              0 (json)
              2 CALL_METHOD              1
              4 STORE_FAST               0 (data)
              6 LIST_EXTEND              1
              8 UNPACK_SEQUENCE          2
             10 LOAD_FAST                1 (login)
             12 LOAD_FAST                2 (password)

  6          14 LOAD_GLOBAL              2 (android)
             16 CALL_METHOD              3
             18 STORE_FAST               1 (login)
             20 LIST_EXTEND              1
             22 LOAD_FAST                1 (login)

  7          24 LOAD_GLOBAL              2 (android)
             26 CALL_METHOD              3
             28 STORE_FAST               2 (password)
             30 LIST_EXTEND              1
             32 LOAD_FAST                2 (password)

  8          34 LOAD_GLOBAL              2 (android)
             36 CALL_METHOD              4
             38 STORE_FAST               1 (login)
             40 STORE_FAST               2 (password)
             42 BINARY_SUBTRACT
             44 LIST_EXTEND              1
             46 CALL_METHOD              5
             48 LIST_EXTEND              0
             50 LOAD_GLOBAL              2 (android)
             52 LOAD_ATTR                6 (__doc__)
             54 COMPARE_OP               2 (==)
             56 RETURN_VALUE

Disassembly of &lt;code object verify at 0x109ae16e0, file &#34;/home/romain/dev/open-obfuscator/challenge/challenge-01/scripts/extra/checker.py&#34;, line 10&gt;:
 11           0 LOAD_GLOBAL              0 (len)
              2 STORE_FAST               0 (data)
              4 MAKE_FUNCTION            1 (defaults)
              6 LOAD_CONST               1 (0)
              8 COMPARE_OP               2 (==)
             10 RETURN_VALUE
</code></pre><br><p>This looks mostly reasonable, but some of the bytecodes look wrong: <code>IMPORT_FROM</code> should be <code>IMPORT_NAME</code>, <code>LOAD_FAST</code> should be <code>STORE_FAST</code>, etc. Indeed, we can guess that we&rsquo;re running on some kind of modified interpreter, where some of the opcodes have been swapped around. This is a popular obfuscation technique, but usually the opcodes are all permuted; swapping just some of the opcodes is a sneaky trick!</p><p>We can guess that the real code looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>import</span> android
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>check</span>(data: <span style=color:#8be9fd;font-style:italic>str</span>) <span style=color:#ff79c6>-&gt;</span> <span style=color:#8be9fd;font-style:italic>bool</span>:
</span></span><span style=display:flex><span>    login, password <span style=color:#ff79c6>=</span> json<span style=color:#ff79c6>.</span>loads(data)
</span></span><span style=display:flex><span>    login <span style=color:#ff79c6>=</span> android<span style=color:#ff79c6>.</span>decode(login)
</span></span><span style=display:flex><span>    password <span style=color:#ff79c6>=</span> android<span style=color:#ff79c6>.</span>decode(password)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> android<span style=color:#ff79c6>.</span>__obfuscated__(login <span style=color:#ff79c6>+</span> password)<span style=color:#ff79c6>.</span>hex() <span style=color:#ff79c6>==</span> android<span style=color:#ff79c6>.</span>__doc__
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>verify</span>(data: <span style=color:#8be9fd;font-style:italic>str</span>) <span style=color:#ff79c6>-&gt;</span> <span style=color:#8be9fd;font-style:italic>bool</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>len</span>(data) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>
</span></span></code></pre></div><br><p><code>__obfuscated__</code> is not in the <code>android</code> module. However, I found this string in the <code>python.elf</code> binary I compiled from <code>libpython3.10.a</code>: it&rsquo;s referenced in <code>_PyEval_EvalFrameDefault</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>iVar6 <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>_PyUnicode_EqualToASCIIString</span>((PyObject <span style=color:#ff79c6>*</span>)pPVar58,<span style=color:#f1fa8c>&#34;__obfuscated__&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> (iVar6 <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>  pPVar58 <span style=color:#ff79c6>=</span> (PyTypeObject <span style=color:#ff79c6>*</span>)<span style=color:#50fa7b>PyUnicode_FromString</span>(<span style=color:#f1fa8c>&#34;MvtKNJXCOGJe&#34;</span>);
</span></span><span style=display:flex><span>  (pPVar58<span style=color:#ff79c6>-&gt;</span>ob_base).ob_base.ob_refcnt <span style=color:#ff79c6>=</span> (pPVar58<span style=color:#ff79c6>-&gt;</span>ob_base).ob_base.ob_refcnt <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><br><p>So, the interpreter has also been hacked to replace mentions of <code>__obfuscated__</code> with <code>MvtKNJXCOGJe</code>, which is in the <code>android</code> module.</p><h3 id=native-code-again>Native code, again</h3><p>Finally, we need to understand the <code>decode</code> (0x2c2640) and <code>MvtKNJXCOGJe</code> (0x2c32e0) functions. <code>decode</code> is straightforward base64 decoding with no obfuscation. <code>MvtKNJXCOGJe</code>, on the other hand, is heavily obfuscated: it&rsquo;s a wrapper for <code>FUN_002c0ea8</code>, which is a fairly long control-flow-flattened function. By following each of the state labels, it&rsquo;s easy enough to reconstruct the overall flow of the function.</p><p>It starts off by putting a bunch of stuff on the stack; a bit of emulation reveals the data:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>uc<span style=color:#ff79c6>.</span>reg_write(UC_ARM64_REG_SP, STACK_TOP)
</span></span><span style=display:flex><span>uc<span style=color:#ff79c6>.</span>reg_write(UC_ARM64_REG_LR, END_ADDR)
</span></span><span style=display:flex><span>uc<span style=color:#ff79c6>.</span>mem_write(STACK_TOP <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>0x1000</span>, <span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\x00</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>0x1000</span>)
</span></span><span style=display:flex><span>uc<span style=color:#ff79c6>.</span>emu_start(<span style=color:#bd93f9>0x1c0ea8</span>, <span style=color:#bd93f9>0x1c0ef0</span>) <span style=color:#6272a4># initialize stack and persistent vars</span>
</span></span><span style=display:flex><span>uc<span style=color:#ff79c6>.</span>emu_start(<span style=color:#bd93f9>0x1c10ec</span>, <span style=color:#bd93f9>0x1c1990</span>)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(uc<span style=color:#ff79c6>.</span>mem_read(STACK_TOP <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>0xc0</span>, <span style=color:#bd93f9>0x40</span>))
</span></span></code></pre></div><br><p>This produces <code>bytearray(b'expand 32-byte ke\x84tp~\xca//b\x92fu~\x93atb\x82.rh\xdf\x00\x00\r\xf0\x00\x00\r\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00')</code>. We can recognize this as the initial state of a ChaCha cipher with a counter and nonce of 0. Indeed, examining some of the functions that are called confirms this suspicion. <code>FUN_0030ca2c</code> in particular performs one double-round of the cipher:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>FUN_0030ca2c</span>(uint <span style=color:#ff79c6>*</span>param_1)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#50fa7b>FUN_0030c698</span>(param_1,<span style=color:#bd93f9>0</span>,<span style=color:#bd93f9>4</span>,<span style=color:#bd93f9>8</span>,<span style=color:#bd93f9>0xc</span>);
</span></span><span style=display:flex><span>  <span style=color:#50fa7b>FUN_0030c698</span>(param_1,<span style=color:#bd93f9>1</span>,<span style=color:#bd93f9>5</span>,<span style=color:#bd93f9>9</span>,<span style=color:#bd93f9>0xd</span>);
</span></span><span style=display:flex><span>  <span style=color:#50fa7b>FUN_0030c698</span>(param_1,<span style=color:#bd93f9>2</span>,<span style=color:#bd93f9>6</span>,<span style=color:#bd93f9>10</span>,<span style=color:#bd93f9>0xe</span>);
</span></span><span style=display:flex><span>  <span style=color:#50fa7b>FUN_0030c698</span>(param_1,<span style=color:#bd93f9>3</span>,<span style=color:#bd93f9>7</span>,<span style=color:#bd93f9>0xb</span>,<span style=color:#bd93f9>0xf</span>);
</span></span><span style=display:flex><span>  <span style=color:#50fa7b>FUN_0030c698</span>(param_1,<span style=color:#bd93f9>0</span>,<span style=color:#bd93f9>5</span>,<span style=color:#bd93f9>10</span>,<span style=color:#bd93f9>0xf</span>);
</span></span><span style=display:flex><span>  <span style=color:#50fa7b>FUN_0030c698</span>(param_1,<span style=color:#bd93f9>1</span>,<span style=color:#bd93f9>6</span>,<span style=color:#bd93f9>0xb</span>,<span style=color:#bd93f9>0xc</span>);
</span></span><span style=display:flex><span>  <span style=color:#50fa7b>FUN_0030c698</span>(param_1,<span style=color:#bd93f9>2</span>,<span style=color:#bd93f9>7</span>,<span style=color:#bd93f9>8</span>,<span style=color:#bd93f9>0xd</span>);
</span></span><span style=display:flex><span>  <span style=color:#50fa7b>FUN_0030c698</span>(param_1,<span style=color:#bd93f9>3</span>,<span style=color:#bd93f9>4</span>,<span style=color:#bd93f9>9</span>,<span style=color:#bd93f9>0xe</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><br><p>After encrypting the input with ChaCha, the <code>MvtKNJXCOGJe</code> function does the following:</p><pre tabindex=0><code>uRam00007fff000cfe98 = 0;
while(1) {
  uRam00007fff000cfde8 = uRam00007fff000cfe98;
  p2_len = string::size((basic_string *)&amp;obf_output);
  if (p2_len &lt;= uRam00007fff000cfde8) {
    FUN_002bfc08(uVar12,&amp;obf_output);
    FUN_0051e7d0(&amp;obf_output);
    lVar6 = tpidr_el0;
    if (*(long *)(lVar6 + 0x28) == lRam00007fff000cffd8) {
      return;
    }
              // WARNING: Subroutine does not return
    __stack_chk_fail();
  }
  pbVar13 = (byte *)string::operator[](&amp;obf_output,uRam00007fff000cfe98);
  /* obfuscated math elided... */
  iRam00007fff000cfde4 = (uint)bVar4 * 17;
  iVar2 = 256;
  iVar5 = 0;
  if (iVar2 != 0) {
    iVar5 = iRam00007fff000cfde4 / iVar2;
  }
  iRam00007fff000cfde4 -= iVar5 * iVar2;
  puVar14 = (undefined *)string::operator[](puVar7,uRam00007fff000cfe98);
  *puVar14 = (char)iRam00007fff000cfde4;
  uRam00007fff000cfe98 += 1;
}
</code></pre><br><p>So, this multiplies each byte with 17, mod 256. This all is easy enough to invert:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>data <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>bytes</span><span style=color:#ff79c6>.</span>fromhex(<span style=color:#f1fa8c>&#39;9c16a9c3017d2b3876323bc4f9dad2b7530c&#39;</span>)
</span></span><span style=display:flex><span>inv17 <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>pow</span>(<span style=color:#bd93f9>17</span>, <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>, <span style=color:#bd93f9>256</span>)
</span></span><span style=display:flex><span>data <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>bytes</span>([(c <span style=color:#ff79c6>*</span> inv17) <span style=color:#ff79c6>%</span> <span style=color:#bd93f9>256</span> <span style=color:#ff79c6>for</span> c <span style=color:#ff79c6>in</span> data])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> Crypto.Cipher <span style=color:#ff79c6>import</span> ChaCha20
</span></span><span style=display:flex><span>key <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#34;e</span><span style=color:#f1fa8c>\x84</span><span style=color:#f1fa8c>tp~</span><span style=color:#f1fa8c>\xca</span><span style=color:#f1fa8c>//b</span><span style=color:#f1fa8c>\x92</span><span style=color:#f1fa8c>fu~</span><span style=color:#f1fa8c>\x93</span><span style=color:#f1fa8c>atb</span><span style=color:#f1fa8c>\x82</span><span style=color:#f1fa8c>.rh</span><span style=color:#f1fa8c>\xdf\x00\x00\r\xf0\x00\x00\r\xf0\x00\x00</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>cipher <span style=color:#ff79c6>=</span> ChaCha20<span style=color:#ff79c6>.</span>new(key<span style=color:#ff79c6>=</span>key, nonce<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#39;</span><span style=color:#f1fa8c>\x00</span><span style=color:#f1fa8c>&#39;</span> <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>8</span>)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>print</span>(cipher<span style=color:#ff79c6>.</span>decrypt(data))
</span></span></code></pre></div><br><p>And we get our final answer, <code>0MvLL_And_dPr0t3ct</code>. (Note that the key is simply <code>https://obfuscator.re/</code> NUL-padded to 32 bytes and XORed with the repeating key <code>\x0d\xf0\x00\x00</code>).</p><h3 id=summary-of-the-program-flow>Summary of the program flow</h3><ul><li>Obfuscated Java/Kotlin code JSON-encodes <code>[base64(login), base64(password)]</code> and passes it to native code</li><li>Obfuscated native code loads a hacked Python interpreter and an extension module <code>android</code> using pybind11</li><li>Lightly obfuscated Python module loads the JSON and calls <code>android.MvtKNJXCOGJe(login + password)</code></li><li><code>android.MvtKNJXCOGJe</code> uses ChaCha20 to encrypt the input, then multiplies each byte by 17</li><li>The final result is compared against an obfuscated string constant.</li></ul><h3 id=summary-of-obfuscation-techniques>Summary of obfuscation techniques</h3><ul><li>dProtect: very little program logic was in Java, so this had minimal impact. In particular, the package name <code>re.obfuscator.challenge01</code> was not obfuscated, nor were crucial functions like <code>toJson</code>.</li><li>run-time checks: not applicable, static reversing only</li><li>ELF protections: easily defeated (<code>rebuild_elf_sections.py</code> plus simply ignoring garbage symbols)</li><li>arithmetic obfuscation: quite annoying in general, but fairly predictable as all encodings were applied the same number of times, making the overall &ldquo;shape&rdquo; of each obfuscated operation discernable.</li><li>opaque constants: largely not an issue by setting <code>SP</code> at the start of each function</li><li>opaque field access: as it depends on opaque constants, not an issue</li><li>control-flow breaking: as it depends on opaque constants, not an issue</li><li>control-flow flattening: definitely annoying; encryption of the variable was not impactful (Ghidra automatically constant-folds) but recovering control flow was done manually in most cases. (Tools exist, but the functions were not sizable enough to warrant using the tools)</li><li>string encoding: surprisingly annoying, especially when written to the stack; the use of obfuscated arithmetic + randomized encoding algorithm meant that emulation was often the fastest way to recover strings</li></ul></section></main><footer class="footer dark-mode bg-dark pt-5 pb-4 pb-lg-5"><div class="container text-center pt-lg-3"><p class="nav d-block fs-sm text-center pt-5 mt-lg-4 mb-0"><span class="text-light opacity-50">Site generated with </span><a class="nav-link d-inline-block p-0" href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a>
<span class="text-light opacity-50">and created by</span>
<a class="nav-link d-inline-block p-0" href=https://www.romainthomas.fr/ target=_blank rel=noopener>R. Thomas</a></p></div></footer><noscript><div class="navbar navbar-expand-lg navbar-dark shadow-sm fixed-bottom d-flex justify-content-center align-items-center"><div class="alert alert-warning fade show" role=alert><i class="fa-solid fa-gingerbread-man me-2"></i>
This website is free from cookies, trackers, and ads but you might want to enable javascript for a
better UI experience.</div></div></noscript><script src=/vendor/bootstrap/dist/js/bootstrap.bundle.min.js></script><script src=/vendor/smooth-scroll/dist/smooth-scroll.polyfills.min.js></script><script src=/vendor/parallax-js/dist/parallax.min.js></script><script src=/vendor/jarallax/dist/jarallax.min.js></script><script src=/vendor/rellax/rellax.min.js></script><script src=/vendor/swiper/swiper-bundle.min.js></script><script src=/vendor/lightgallery/lightgallery.min.js></script><script src=/vendor/lightgallery/plugins/video/lg-video.min.js></script><script>jarallax(document.querySelectorAll(".jarallax"),{speed:.2})</script><script src=/js/theme.min.js></script><script src=/js/anime.min.js></script></body></html>