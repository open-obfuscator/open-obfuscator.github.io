<!doctype html><html class=dark-mode lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=manifest href=manifest.webmanifest><link rel=icon type=image/svg+xml href=/favicon/favicon.svg><link rel=icon type=image/png href=/favicon/favicon_hue529d2a9513ea41889fd87b18b80b0ed_11211_32x32_fill_box_center_3.png><link rel="shortcut icon" type=image/png href=/favicon/favicon_hue529d2a9513ea41889fd87b18b80b0ed_11211_192x192_fill_box_center_3.png><link rel=apple-touch-icon type=image/png href=/favicon/favicon_hue529d2a9513ea41889fd87b18b80b0ed_11211_192x192_fill_box_center_3.png><meta name=description content="This pass can be used to transform arithmetic operations into Mixed Boolean-Arithmetic expressions"><meta property="og:type" content="website"><meta property="og:description" content="This pass can be used to transform arithmetic operations into Mixed Boolean-Arithmetic expressions"><meta property="og:title" content="Arithmetic Obfuscation | Open Obfuscator: A free and open-source solution for obfuscating mobile applications."><meta property="og:site_name" content="Open Obfuscator: A free and open-source solution for obfuscating mobile applications."><meta property="og:url" content="https://obfuscator.re/omvll/passes/arithmetic/"><meta property="og:locale" content="en-us"><meta property="article:modified_time" content="2022-10-26T18:49:48+02:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@open_obfuscator"><meta name=twitter:creator content="@rh0main"><meta name=twitter:title content="Arithmetic Obfuscation | Open Obfuscator: A free and open-source solution for obfuscating mobile applications."><meta name=twitter:description content="This pass can be used to transform arithmetic operations into Mixed Boolean-Arithmetic expressions"><meta name=twitter:domain content="https://obfuscator.re/omvll/passes/arithmetic/"><title>Arithmetic Obfuscation | O-MVLL Documentation</title><link rel=canonical href=https://obfuscator.re/omvll/passes/arithmetic/><link rel=stylesheet href=/css/fa-all.min.css><link rel=stylesheet href=/vendor/swiper/swiper-bundle.min.css><link rel=stylesheet href=/vendor/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/vendor/img-comparison-slider/dist/styles.css><link rel=stylesheet href=/css/theme.min.css></head><body><main class=page-wrapper><header class="header navbar navbar-expand bg-light border-bottom border-light shadow fixed-top" data-scroll-header><div class="container-fluid pe-lg-4"><div class="d-flex align-items-center px-4"><a href=https://obfuscator.re/omvll/passes/ class="navbar-brand flex-shrink-0 py-1 py-lg-2">O-MVLL</a></div><div class="d-flex align-items-center w-100"><ul class="navbar-nav d-none d-lg-flex" style=padding-left:11.75rem><li class=nav-item><a href=https://github.com/open-obfuscator/o-mvll target=_blank class=nav-link><i class="fa-brands fa-github opacity-70 fs-lg me-1"></i>
&nbsp;Source Code</a></li><li class=nav-item><a href=https://github.com/open-obfuscator/o-mvll/releases/ target=_blank class=nav-link><i class="fa-solid fa-download opacity-70 fs-lg me-1"></i>
&nbsp;Download</a></li></ul><button type=button class="navbar-toggler d-block d-lg-none ms-auto me-4" data-bs-toggle=offcanvas data-bs-target=#docsNav aria-controls=docsNav aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="form-check form-switch mode-switch pe-lg-1 ms-lg-auto" data-bs-toggle=obfuscator><input type=checkbox class="form-check-input mt-1" id=which-obfuscator checked>
<label class="form-check-label d-none d-sm-block d-lg-none d-xl-block text-gradient-dprotect" for=theme-mode><strong>dProtect</strong></label>
<label class="form-check-label d-none d-sm-block d-lg-none d-xl-block text-gradient-omvll" for=theme-mode><strong>O-MVLL</strong></label></div><a href=https://obfuscator.re/ class="btn btn-primary btn-sm fs-sm rounded ms-4 d-none d-lg-inline-flex"><i class="fa-sharp fa-solid fa-house-heart fs-5 lh-1 me-1"></i>
&nbsp;Home</a></div></div></header><aside class=dark-mode><div id=docsNav class="offcanvas-lg offcanvas-start d-flex flex-column position-fixed top-0 start-0 vh-100 bg-dark border-end-lg" style=width:21rem;z-index:1045><div class="offcanvas-header d-none d-lg-flex justify-content-start"><a href=/omvll/ class="navbar-brand text-dark d-none d-lg-flex py-0"><svg xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" width="26.456686" height="26.974693" viewBox="0 0 6.9999978 7.1370545" id="svg20282" sodipodi:docname="omvll.svg"><sodipodi:namedview id="namedview20284" pagecolor="#ffffff" bordercolor="#000000" borderopacity=".25" showgrid="false"/><defs id="defs20279"/><g id="layer1" transform="translate(-2.7177092,-2.2523059)"><g id="g34542" transform="matrix(0.01393956,0,0,0.01393956,2.6491795,2.252306)" style="font-size:80px;font-family:brolink demo;-inkscape-font-specification:'Brolink DEMO, Normal';display:inline;opacity:.778276;stroke-width:37.9613;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:2;stroke-dasharray:4.79781,9.59564"><g id="g34508" style="stroke-width:37.9613"><path d="m162.144 193.719s67.743-16.576 50.853-114.74c0 0 81.408-135.816 257.901-50.836.0.0-114.839 23.251-86.081 138.61.0.0-77.272-16.404-96.43 49.396.0.0-39.238-26.305-76.384 13.254.001.0-31.497 4.809-49.859-35.684z" fill="#5bc992" id="path34504" style="fill:#0d3758;fill-opacity:1;stroke-width:258.859"/><path d="m168.14 196.604c-3.557.0-6.756-2.472-7.539-6.09-.898-4.15 1.723-8.243 5.861-9.168 1.823-.428 42.24-10.743 40.627-79.558-.229-9.782-1.411-20.039-3.511-30.485l-2.197-10.93c-.84-4.18 1.868-8.251 6.048-9.092 4.184-.838 8.251 1.868 9.092 6.048l2.197 10.93c2.277 11.327 3.559 22.486 3.81 33.167.547 23.372-3.317 55.876-24.841 77.998-13.361 13.732-27.318 16.877-27.906 17.004-.55.118-1.1.176-1.641.176z" fill="#0bb494" id="path34506" style="fill:#59aae8;fill-opacity:.992157;stroke-width:258.859"/></g><g id="g34514" style="stroke-width:37.9613"><path d="m230.826 252.7c40.616-35.987 77.278-6.195 77.278-6.195 25.11-63.766 100.553-40.346 100.553-40.346-18.06-117.51 98.427-130.134 98.427-130.134-167.958-100.804-261.476 26.976-261.476 26.976 7.818 99.299-61.159 109.594-61.159 109.594s10.647 24.683 46.377 40.105z" fill="#6fd7a3" id="path34510" style="fill:#135587;fill-opacity:1;stroke-width:258.859"/><path d="m190.86 216.05c-3.848.0-7.177-2.872-7.655-6.788-.514-4.215 2.472-8.051 6.676-8.593 1.85-.258 43.048-6.821 47.752-75.499.668-9.759.432-20.08-.702-30.678l-1.186-11.085c-.453-4.24 2.616-8.046 6.856-8.499 4.242-.449 8.046 2.616 8.499 6.856l1.186 11.085c1.23 11.492 1.483 22.721.753 33.377-1.598 23.324-8.426 55.337-31.888 75.392-14.564 12.449-28.751 14.301-29.348 14.374-.316.039-.631.058-.943.058z" fill="#0bb494" id="path34512" style="fill:#59aae8;fill-opacity:.992157;stroke-width:258.859"/></g><path d="m99.22 32.25c54.02-16.304 94.124 31.976 82.031 97.634-11.942 64.843 13.555 101.705 49.575 122.816 34.936 20.476 92.97 61.763 97.24 138.002 7.207 128.69-146.88 153.812-189.774 79.616-38.092-65.889 25.07-126.332 25.07-126.332l15.768 13.085s-54.212 57.459-6.717 98.644c41.377 35.88 119.62 4.994 94.473-63.798-22.727-62.169-113.186-48.785-155.96-107.49C70.063 228.345 104.751 176.066 120.847 144.993c26.901-51.934 11.207-94.471-22.844-80.767z" fill="#c9f6b0" id="path34516" style="fill:#1b71af;fill-opacity:1;stroke-width:258.859"/><g id="g34520" style="stroke-width:37.9613"><path d="M328.066 390.702C323.797 314.463 265.762 273.176 230.826 252.7c-36.02-21.111-61.517-57.973-49.575-122.816C193.344 64.227 153.24 15.946 99.22 32.25l-.016.427c31.181 11.593 49.582 49.885 40.867 97.207-11.942 64.843 13.555 101.705 49.575 122.816 34.936 20.476 92.97 61.763 97.24 138.002 3.97 70.889-41.004 110.348-89.374 119.094 59.897 11.218 135.657-27.974 130.554-119.094z" fill="#bbf49b" id="path34518" style="fill:#155d91;fill-opacity:1;stroke-width:258.859"/></g><path d="M86.13 29.061 146.528.0s-10.295 53.02-52.157 74.817L75.834 69.492z" fill="#6fd7a3" id="path34522" style="fill:#0cf;fill-opacity:1;stroke-width:258.859"/><path d="m108.988.0-14.942 49.333.325 25.484c.132 10.356-5.648 19.894-14.922 24.625l-53.66 27.374C13.17 133.254-.159 119.45 6.856 107.202c8.309-14.507 17.855-31.646 27.245-49.53C41.851 42.911 53.79 30.729 68.409 22.59z" fill="#c9f6b0" id="path34524" style="fill:#2a95e1;fill-opacity:1;stroke-width:258.859"/><path d="m181.814 315.601c4.614-3.907 11.558.252 10.29 6.164l-6.293 29.354-7.207 33.619c-1.15 5.364-8.11 6.832-11.328 2.389L157.07 373.035c-1.033-1.427-2.614-2.359-4.362-2.573l-16.799-2.056c-5.486-.672-7.543-7.554-3.325-11.126l26.177-22.163z" fill="#6fd7a3" id="path34526" style="fill:#2ad4ff;fill-opacity:.992157;stroke-width:258.859"/><path d="m408.662 213.882c-2.855.0-5.599-1.59-6.939-4.325-.083-.168-8.514-17.05-27.948-36.153-17.846-17.542-48.949-40.642-95.775-51.077-4.162-.927-6.784-5.054-5.857-9.216.927-4.162 5.05-6.787 9.216-5.857 50.722 11.302 84.422 36.5 103.761 55.648 21.095 20.887 30.105 39.107 30.478 39.872 1.869 3.833.277 8.455-3.556 10.324-1.091.533-2.244.784-3.38.784z" fill="#0bb494" id="path34528" style="fill:#59aae8;fill-opacity:.992157;stroke-width:258.859"/><path d="m308.106 254.226c-.035.0-.068.0-.103-.001-4.254-.056-7.66-3.541-7.62-7.792.0-.459-.233-27.156-22.522-73.746-1.84-3.847-.214-8.457 3.633-10.298s8.457-.214 10.298 3.633c24.143 50.465 24.049 79.377 24.033 80.583-.056 4.231-3.502 7.621-7.719 7.621z" fill="#0bb494" id="path34530" style="fill:#59aae8;fill-opacity:.992157;stroke-width:258.859"/><g fill="#6fd7a3" id="g34540" style="display:inline;stroke-width:258.859"><path d="m293.41 353.127c-2.935.0-5.74-1.682-7.034-4.528-1.765-3.882-.048-8.459 3.834-10.224 6.955-3.161 18.792-10.715 18.911-10.791 3.592-2.297 8.368-1.248 10.665 2.345s1.248 8.367-2.345 10.665c-.522.334-12.881 8.222-20.84 11.839-1.036.47-2.122.694-3.191.694z" id="path34532" style="fill:#2b97e2;fill-opacity:.992157;stroke-width:37.9613"/><path d="m308.098 407.232c-4.104.0-7.52-3.231-7.707-7.372-.193-4.26 3.104-7.87 7.364-8.063l20.207-.915c4.259-.189 7.87 3.104 8.063 7.364s-3.104 7.87-7.364 8.063l-20.207.915c-.119.005-.238.008-.356.008z" id="path34534" style="fill:#2b97e2;fill-opacity:.992157;stroke-width:37.9613"/><path d="m310.641 470.991c-1.381.0-2.779-.37-4.042-1.148l-14.183-8.736c-3.631-2.236-4.762-6.993-2.525-10.623 2.236-3.632 6.993-4.762 10.623-2.525l14.184 8.736c3.631 2.236 4.762 6.993 2.525 10.623-1.459 2.368-3.99 3.673-6.582 3.673z" id="path34536" style="fill:#2b97e2;fill-opacity:.992157;stroke-width:37.9613"/><path d="m258.788 512c-2.901.0-5.679-1.642-6.994-4.441l-7.245-15.427c-1.813-3.86-.153-8.458 3.707-10.271 3.858-1.813 8.458-.153 10.271 3.707l7.245 15.427c1.813 3.86.153 8.458-3.707 10.271-1.06.498-2.177.734-3.277.734z" id="path34538" style="fill:#2b97e2;fill-opacity:.992157;stroke-width:37.9613"/></g></g></g></svg></a><span class="badge bg-omvll d-none d-lg-inline-block"><strong>O-MVLL</strong></span></div><div class="offcanvas-header d-block d-lg-none border-bottom"><div class="d-flex align-items-center justify-content-between mb-3"><h5 class="d-lg-none mb-0">Menu</h5><button type=button class="btn-close d-lg-none" data-bs-dismiss=offcanvas data-bs-target=#docsNav></button></div><div class="list-group list-group-flush mx-n4"><a href=https://github.com/open-obfuscator/o-mvll target=_blank class="list-group-item list-group-item-action d-flex align-items-center border-0 py-2 px-4"><i class="fa-brands fa-github fs-lg opacity-80 me-2"></i>
Source Code</a>
<a href=https://github.com/open-obfuscator/o-mvll/releases/ target=_blank class="list-group-item list-group-item-action d-flex align-items-center border-0 py-2 px-4"><i class="fa-solid fa-download fs-lg opacity-80 me-2"></i>
Download</a></div></div><div class="offcanvas-body p-4"><div class=swiper-wrapper><div class="swiper-slide h-auto"><h3 class=fs-lg><a href=https://obfuscator.re/omvll/introduction/>Introduction</a></h3><div class="list-group list-group-flush mx-n4 pb-2"><a href=https://obfuscator.re/omvll/introduction/getting-started/ class="list-group-item list-group-item-action border-0 py-2 px-4">Getting started</a>
<a href=https://obfuscator.re/omvll/introduction/compilation/ class="list-group-item list-group-item-action border-0 py-2 px-4">Compilation</a>
<a href=https://open-obfuscator.github.io/o-mvll target=_blank class="list-group-item list-group-item-action border-0 py-2 px-4">API</a></div><h3 class=fs-lg><a href=https://obfuscator.re/omvll/passes/>Obfuscation Passes</a></h3><div class="list-group list-group-flush mx-n4 pb-2"><a href=https://obfuscator.re/omvll/passes/anti-hook/ class="list-group-item list-group-item-action border-0 py-2 px-4"><span class="fa-regular fa-tachograph-digital me-2"></span>
Anti-Hooking</a>
<a href=https://obfuscator.re/omvll/passes/arithmetic/ class="list-group-item list-group-item-action border-0 py-2 px-4 active"><span class="fa-regular fa-calculator-simple me-2"></span>
Arithmetic Obfuscation</a>
<a href=https://obfuscator.re/omvll/passes/control-flow-breaking/ class="list-group-item list-group-item-action border-0 py-2 px-4"><span class="fa-regular fa-chart-tree-map me-2"></span>
Control-Flow Breaking</a>
<a href=https://obfuscator.re/omvll/passes/control-flow-flattening/ class="list-group-item list-group-item-action border-0 py-2 px-4"><span class="fa-regular fa-cubes-stacked me-2"></span>
Control-Flow Flattening</a>
<a href=https://obfuscator.re/omvll/passes/objcleaner/ class="list-group-item list-group-item-action border-0 py-2 px-4"><span class="fa-brands fa-apple me-2"></span>
Objective-C Cleaner</a>
<a href=https://obfuscator.re/omvll/passes/opaque-constants/ class="list-group-item list-group-item-action border-0 py-2 px-4"><span class="fa-regular fa-input-numeric me-2"></span>
Opaque Constants</a>
<a href=https://obfuscator.re/omvll/passes/opaque-fields-access/ class="list-group-item list-group-item-action border-0 py-2 px-4"><span class="fa-regular fa-arrow-right me-2"></span>
Opaque Fields Access</a>
<a href=https://obfuscator.re/omvll/passes/strings-encoding/ class="list-group-item list-group-item-action border-0 py-2 px-4"><span class="fa-regular fa-square-a-lock me-2"></span>
Strings Encoding</a></div><h3 class=fs-lg><a href=https://obfuscator.re/omvll/other-topics/>Other Topics</a></h3><div class="list-group list-group-flush mx-n4 pb-2"><a href=https://obfuscator.re/omvll/other-topics/troubleshooting/ class="list-group-item list-group-item-action border-0 py-2 px-4">Troubleshooting</a>
<a href=https://obfuscator.re/omvll/other-topics/jit/ class="list-group-item list-group-item-action border-0 py-2 px-4">LLVM JIT</a>
<a href=https://obfuscator.re/omvll/other-topics/annotations/ class="list-group-item list-group-item-action border-0 py-2 px-4">Obfuscation Annotations</a></div></div></div><div class="swiper-scrollbar end-0"></div></div><div class="offcanvas-header border-top"><a href=https://obfuscator.re/ class="btn btn-primary w-100" target=_blank rel=noopener><i class="fa-sharp fa-solid fa-house-heart fs-4 lh-1 me-1"></i>
&nbsp;Home</a></div></div></aside><main class="docs-container pt-5 pb-3 pb-lg-4"><div class="container-fluid px-xxl-5 px-lg-4 pt-4 pt-lg-5 pb-4"><section class="container ms-0"><div class=row><aside class="col-lg-4 col-md-5 offset-xl-1 order-md-2 mb-5"><div style=margin-top:-96px></div><div class="position-sticky top-0 pt-5"><div class="pt-5 mt-md-3"><div class="card shadow-sm p-sm-3"><div class=card-body><h4 class=mb-4>Summary</h4><ul class=list-unstyled><li class="d-flex align-items-center mb-2"><i class="fa-light fa-shield fs-xl text-muted me-2 pe-1"></i>
<strong class=me-2>Protection:</strong><div class="d-flex align-items-center"><span class="badge bg-info me-1">Static</span></div></li><li class="d-flex align-items-center mb-2"><i class="fa-light fa-circle-nodes fs-xl text-muted me-2 pe-1"></i>
<strong class=me-1>Resilience:</strong> Medium</li><li class="d-flex align-items-center mb-2"><i class="fa-light fa-gear fs-xl text-muted me-2 pe-1"></i>
<strong class=me-1>Overhead:</strong> Code & Execution</li><li class="d-flex align-items-center mb-2"><i class="fa-light fa-user-secret fs-xl text-muted me-2 pe-1"></i>
<strong class=me-1>Public Attacks:</strong> Yes</li></ul><a href=https://github.com/open-obfuscator/o-mvll/tree/main/src/passes/arithmetic target=_blank class="btn btn-primary btn shadow-primary"><span class="fa-brands fa-github fs-xl me-3"></span>Source Code</a></div></div></div></div></aside><div class="col-xl-7 col-lg-8 col-md-7 order-md-1 mb-5 hugo-generated omvll"><h1 id=arithmetic-obfuscation><i class="fa-regular fa-calculator-simple me-1"></i> Arithmetic Obfuscation</h1><div class="alert d-flex alert-success" role=alert><i class="fa-solid fa-shield-cat lead me-3"></i><div>The purpose of this pass is to transform arithmetic operations into complex expressions.</div></div><img-comparison-slider class=omvll><figure slot=first class=position-relative><svg xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" width="903.961" height="569.15997" viewBox="0 0 239.17329 150.59024" id="svg5" sodipodi:docname="arithmetic-2.svg"><sodipodi:namedview id="namedview7" pagecolor="#ffffff" bordercolor="#000000" borderopacity=".25" showgrid="true"/><defs id="defs2"><rect x="22.319975" y="66.959999" width="1004.6432" height="670.60968" id="rect2499"/></defs><g id="layer1"><g id="g26287" transform="matrix(0.26458333,0,0,0.26458333,151.03674,16.444252)"><g id="g26211" transform="translate(-559.68753,-50.991504)"><path style="fill:#20283c;fill-opacity:1" d="M850.74201 546.84001H30.897c-17.064.0-30.897-13.833-30.897-30.897V42.057C0 24.993 13.833 11.16 30.897 11.16h819.84601c17.064.0 30.897 13.833 30.897 30.897v473.88601c-.001 17.064-13.834 30.897-30.898 30.897z" id="path26201" sodipodi:nodetypes="ssssssscs"/><g id="g34542" transform="matrix(0.22579297,0,0,0.22579297,19.537281,407.67356)" style="font-size:80px;font-family:brolink demo;-inkscape-font-specification:'Brolink DEMO, Normal';display:inline;opacity:1;stroke-width:8.85763;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:2;stroke-dasharray:1.11949,2.23898"><g id="g34508" style="stroke-width:8.85763"><path d="m162.144 193.719s67.743-16.576 50.853-114.74c0 0 81.408-135.816 257.901-50.836.0.0-114.839 23.251-86.081 138.61.0.0-77.272-16.404-96.43 49.396.0.0-39.238-26.305-76.384 13.254.001.0-31.497 4.809-49.859-35.684z" fill="#5bc992" id="path34504" style="fill:#0d3758;fill-opacity:1;stroke-width:60.4005"/><path d="m168.14 196.604c-3.557.0-6.756-2.472-7.539-6.09-.898-4.15 1.723-8.243 5.861-9.168 1.823-.428 42.24-10.743 40.627-79.558-.229-9.782-1.411-20.039-3.511-30.485l-2.197-10.93c-.84-4.18 1.868-8.251 6.048-9.092 4.184-.838 8.251 1.868 9.092 6.048l2.197 10.93c2.277 11.327 3.559 22.486 3.81 33.167.547 23.372-3.317 55.876-24.841 77.998-13.361 13.732-27.318 16.877-27.906 17.004-.55.118-1.1.176-1.641.176z" fill="#0bb494" id="path34506" style="fill:#59aae8;fill-opacity:.992157;stroke-width:60.4005"/></g><g id="g34514" style="stroke-width:8.85763"><path d="m230.826 252.7c40.616-35.987 77.278-6.195 77.278-6.195 25.11-63.766 100.553-40.346 100.553-40.346-18.06-117.51 98.427-130.134 98.427-130.134-167.958-100.804-261.476 26.976-261.476 26.976 7.818 99.299-61.159 109.594-61.159 109.594s10.647 24.683 46.377 40.105z" fill="#6fd7a3" id="path34510" style="fill:#135587;fill-opacity:1;stroke-width:60.4005"/><path d="m190.86 216.05c-3.848.0-7.177-2.872-7.655-6.788-.514-4.215 2.472-8.051 6.676-8.593 1.85-.258 43.048-6.821 47.752-75.499.668-9.759.432-20.08-.702-30.678l-1.186-11.085c-.453-4.24 2.616-8.046 6.856-8.499 4.242-.449 8.046 2.616 8.499 6.856l1.186 11.085c1.23 11.492 1.483 22.721.753 33.377-1.598 23.324-8.426 55.337-31.888 75.392-14.564 12.449-28.751 14.301-29.348 14.374-.316.039-.631.058-.943.058z" fill="#0bb494" id="path34512" style="fill:#59aae8;fill-opacity:.992157;stroke-width:60.4005"/></g><path d="m99.22 32.25c54.02-16.304 94.124 31.976 82.031 97.634-11.942 64.843 13.555 101.705 49.575 122.816 34.936 20.476 92.97 61.763 97.24 138.002 7.207 128.69-146.88 153.812-189.774 79.616-38.092-65.889 25.07-126.332 25.07-126.332l15.768 13.085s-54.212 57.459-6.717 98.644c41.377 35.88 119.62 4.994 94.473-63.798-22.727-62.169-113.186-48.785-155.96-107.49C70.063 228.345 104.751 176.066 120.847 144.993c26.901-51.934 11.207-94.471-22.844-80.767z" fill="#c9f6b0" id="path34516" style="fill:#1b71af;fill-opacity:1;stroke-width:60.4005"/><g id="g34520" style="stroke-width:8.85763"><path d="M328.066 390.702C323.797 314.463 265.762 273.176 230.826 252.7c-36.02-21.111-61.517-57.973-49.575-122.816C193.344 64.227 153.24 15.946 99.22 32.25l-.016.427c31.181 11.593 49.582 49.885 40.867 97.207-11.942 64.843 13.555 101.705 49.575 122.816 34.936 20.476 92.97 61.763 97.24 138.002 3.97 70.889-41.004 110.348-89.374 119.094 59.897 11.218 135.657-27.974 130.554-119.094z" fill="#bbf49b" id="path34518" style="fill:#155d91;fill-opacity:1;stroke-width:60.4005"/></g><path d="M86.13 29.061 146.528.0s-10.295 53.02-52.157 74.817L75.834 69.492z" fill="#6fd7a3" id="path34522" style="fill:#0cf;fill-opacity:1;stroke-width:60.4005"/><path d="m108.988.0-14.942 49.333.325 25.484c.132 10.356-5.648 19.894-14.922 24.625l-53.66 27.374C13.17 133.254-.159 119.45 6.856 107.202c8.309-14.507 17.855-31.646 27.245-49.53C41.851 42.911 53.79 30.729 68.409 22.59z" fill="#c9f6b0" id="path34524" style="fill:#2a95e1;fill-opacity:1;stroke-width:60.4005"/><path d="m181.814 315.601c4.614-3.907 11.558.252 10.29 6.164l-6.293 29.354-7.207 33.619c-1.15 5.364-8.11 6.832-11.328 2.389L157.07 373.035c-1.033-1.427-2.614-2.359-4.362-2.573l-16.799-2.056c-5.486-.672-7.543-7.554-3.325-11.126l26.177-22.163z" fill="#6fd7a3" id="path34526" style="fill:#2ad4ff;fill-opacity:.992157;stroke-width:60.4005"/><path d="m408.662 213.882c-2.855.0-5.599-1.59-6.939-4.325-.083-.168-8.514-17.05-27.948-36.153-17.846-17.542-48.949-40.642-95.775-51.077-4.162-.927-6.784-5.054-5.857-9.216.927-4.162 5.05-6.787 9.216-5.857 50.722 11.302 84.422 36.5 103.761 55.648 21.095 20.887 30.105 39.107 30.478 39.872 1.869 3.833.277 8.455-3.556 10.324-1.091.533-2.244.784-3.38.784z" fill="#0bb494" id="path34528" style="fill:#59aae8;fill-opacity:.992157;stroke-width:60.4005"/><path d="m308.106 254.226c-.035.0-.068.0-.103-.001-4.254-.056-7.66-3.541-7.62-7.792.0-.459-.233-27.156-22.522-73.746-1.84-3.847-.214-8.457 3.633-10.298s8.457-.214 10.298 3.633c24.143 50.465 24.049 79.377 24.033 80.583-.056 4.231-3.502 7.621-7.719 7.621z" fill="#0bb494" id="path34530" style="fill:#59aae8;fill-opacity:.992157;stroke-width:60.4005"/><g fill="#6fd7a3" id="g34540" style="display:inline;stroke-width:60.4005"><path d="m293.41 353.127c-2.935.0-5.74-1.682-7.034-4.528-1.765-3.882-.048-8.459 3.834-10.224 6.955-3.161 18.792-10.715 18.911-10.791 3.592-2.297 8.368-1.248 10.665 2.345s1.248 8.367-2.345 10.665c-.522.334-12.881 8.222-20.84 11.839-1.036.47-2.122.694-3.191.694z" id="path34532" style="fill:#2b97e2;fill-opacity:.992157;stroke-width:8.85763"/><path d="m308.098 407.232c-4.104.0-7.52-3.231-7.707-7.372-.193-4.26 3.104-7.87 7.364-8.063l20.207-.915c4.259-.189 7.87 3.104 8.063 7.364s-3.104 7.87-7.364 8.063l-20.207.915c-.119.005-.238.008-.356.008z" id="path34534" style="fill:#2b97e2;fill-opacity:.992157;stroke-width:8.85763"/><path d="m310.641 470.991c-1.381.0-2.779-.37-4.042-1.148l-14.183-8.736c-3.631-2.236-4.762-6.993-2.525-10.623 2.236-3.632 6.993-4.762 10.623-2.525l14.184 8.736c3.631 2.236 4.762 6.993 2.525 10.623-1.459 2.368-3.99 3.673-6.582 3.673z" id="path34536" style="fill:#2b97e2;fill-opacity:.992157;stroke-width:8.85763"/><path d="m258.788 512c-2.901.0-5.679-1.642-6.994-4.441l-7.245-15.427c-1.813-3.86-.153-8.458 3.707-10.271 3.858-1.813 8.458-.153 10.271 3.707l7.245 15.427c1.813 3.86.153 8.458-3.707 10.271-1.06.498-2.177.734-3.277.734z" id="path34538" style="fill:#2b97e2;fill-opacity:.992157;stroke-width:8.85763"/></g></g><text transform="matrix(1.0000012,0,0,1.0000012,-11.40444,-12.169992)" id="text2497" style="font-style:normal;font-variant:normal;font-weight:500;font-stretch:normal;font-size:28px;font-family:fira code;-inkscape-font-specification:'Fira Code, Medium';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;white-space:pre;shape-inside:url(#rect2499);display:inline;fill:#2a96e2;fill-opacity:1;stroke-width:2;stroke-linecap:round;stroke-miterlimit:2;paint-order:fill markers stroke"><tspan x="22.320312" y="91.460938" id="tspan18255"/><tspan x="22.320312" y="126.46094" id="tspan18257">int add = (x &amp; y) + (x | y);</tspan><tspan x="22.320312" y="161.46094" id="tspan18259"/><tspan x="22.320312" y="196.46094" id="tspan18261">int sub = (x ^ -y) + 2*(x &amp; -y);</tspan><tspan x="22.320312" y="231.46094" id="tspan18263"/><tspan x="22.320312" y="266.46094" id="tspan18265">int xor = (x | y) - (x &amp; y);</tspan><tspan x="22.320312" y="301.46094" id="tspan18267"/><tspan x="22.320312" y="336.46094" id="tspan18269">int and = (x + y) - (x | y);</tspan><tspan x="22.320312" y="371.46094" id="tspan18271"/><tspan x="22.320312" y="406.46094" id="tspan18273">int or = x + y + 1 + (~x | ~y);</tspan></text><g id="g41581"><path style="fill:#2686ca;fill-opacity:1" d="M881.64001 44.64H.0010028L0 30.897C-.00124512 13.833 13.833.0 30.897.0h819.84601c17.063.0 30.896 13.833 30.896 30.897z" id="path26203" sodipodi:nodetypes="ccssssc"/><g id="g41563" style="stroke-width:13.8026" transform="matrix(0.50127704,0,0,0.50127704,818.45376,3.7727494)"><path d="M37 72A1 1 0 0136.578 71.907C19.185 63.811 8.8 49.853 8.8 34.57V13.46a1 1 0 01.327-.74.992.992.0 01.769-.256C20.887 13.518 29.508 10.209 36.24 2.35A1 1 0 0137 2 1 1 0 0137.76 2.352c6.586 7.733 15.213 11.048 26.357 10.111a1 1 0 011.083 1V34.57a29.339 29.339.0 01-.144 3 33.031 33.031.0 01-1.475 7.2 31.017 31.017.0 01-1.132 3.056 38.379 38.379.0 01-4.011 7.183c-.2.3-.434.62-.669.939A53.361 53.361.0 0137.422 71.907 1 1 0 0137 72zM10.8 14.547V34.57c0 14.362 9.785 27.539 26.2 35.33A51.137 51.137.0 0056.149 54.781c.226-.3.44-.592.635-.889a36.4 36.4.0 003.824-6.841 29.481 29.481.0 001.067-2.877 31.048 31.048.0 001.389-6.793A26.935 26.935.0 0063.2 34.57V14.535C52.3 15.2 43.707 11.91 37 4.513c-6.842 7.516-15.433 10.806-26.2 10.034z" id="path35138" style="fill:#c11e2c;fill-opacity:1;stroke:#20283c;stroke-width:1.99491;stroke-dasharray:none;stroke-opacity:1"/><path d="m58.031 38.47a.884.884.0 01-.125-.008 1 1 0 01-.868-1.116 22.223 22.223.0 00.162-2.776 1.0000125 1.0000125.0 012-.01v.01a24.073 24.073.0 01-.178 3.024 1 1 0 01-.991.876z" id="path35140" style="fill:#c11e2c;fill-opacity:1;stroke:#20283c;stroke-width:1.99491;stroke-dasharray:none;stroke-opacity:1"/><path d="m54.929 48.44a1 1 0 01-.884-1.466 27.324 27.324.0 001.312-2.864 1.0000445 1.0000445.0 111.866.72 29.149 29.149.0 01-1.409 3.076 1 1 0 01-.885.534z" id="path35142" style="fill:#c11e2c;fill-opacity:1;stroke:#20283c;stroke-width:1.99491;stroke-dasharray:none;stroke-opacity:1"/><path d="M37 65.31A1.01 1.01.0 0136.534 65.195C22.925 58.028 14.8 46.579 14.8 34.57V19.61a1 1 0 01.952-1 33.729 33.729.0 0020.6-7.936 1 1 0 011.288.0 34.181 34.181.0 0020.611 7.878 1 1 0 01.946 1v8.01a1 1 0 11-2 0V20.487A36.02 36.02.0 0137 12.734 35.561 35.561.0 0116.8 20.552V34.57c0 11.285 7.354 21.688 20.2 28.607a45.135 45.135.0 0012.247-9.406 1 1 0 111.486 1.338A47.372 47.372.0 0137.466 65.195 1.01 1.01.0 0137 65.31z" id="path35144" style="fill:#c11e2c;fill-opacity:1;stroke:#20283c;stroke-width:1.99491;stroke-dasharray:none;stroke-opacity:1"/></g></g></g></g></g></svg></figure><figure slot=second class=position-relative><svg xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" width="903.961" height="569.15997" viewBox="0 0 239.17329 150.59024" id="svg5"><defs id="defs2"><rect x="22.319975" y="66.959999" width="848.159" height="479.88" id="rect2499"/></defs><g id="layer1"><g id="g26287" transform="matrix(0.26458333,0,0,0.26458333,151.03674,16.444252)"><g id="g26211" transform="translate(-559.68753,-50.991504)" style="display:inline"><path style="fill:#e6e6e6;fill-opacity:1" d="M850.74201 546.84001H30.897c-17.064.0-30.897-13.833-30.897-30.897V42.057C0 24.993 13.833 11.16 30.897 11.16h819.84601c17.064.0 30.897 13.833 30.897 30.897v473.88601c-.001 17.064-13.834 30.897-30.898 30.897z" id="path26201"/><path style="fill:#434141;fill-opacity:1" d="M881.64001 44.64H.0010028L0 30.897C-.00124512 13.833 13.833.0 30.897.0h819.84601c17.063.0 30.896 13.833 30.896 30.897z" id="path26203"/><text transform="matrix(1.0000012,0,0,1.0000012,-11.159998,-11.160334)" id="text2497" style="font-style:normal;font-variant:normal;font-weight:500;font-stretch:normal;font-size:28px;font-family:fira code;-inkscape-font-specification:'Fira Code, Medium';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;white-space:pre;shape-inside:url(#rect2499);display:inline;opacity:1;fill:#434141;fill-opacity:1;stroke-width:2;stroke-linecap:round;stroke-miterlimit:2;paint-order:fill markers stroke"><tspan x="22.320312" y="91.460938" id="tspan6499"/><tspan x="22.320312" y="126.46094" id="tspan6501">int add = x + y;</tspan><tspan x="22.320312" y="161.46094" id="tspan6503"/><tspan x="22.320312" y="196.46094" id="tspan6505">int sub = x - y;</tspan><tspan x="22.320312" y="231.46094" id="tspan6507"/><tspan x="22.320312" y="266.46094" id="tspan6509">int xor = x ^ y;</tspan><tspan x="22.320312" y="301.46094" id="tspan6511"/><tspan x="22.320312" y="336.46094" id="tspan6513">int and = x &amp; y;</tspan><tspan x="22.320312" y="371.46094" id="tspan6515"/><tspan x="22.320312" y="406.46094" id="tspan6517">int or = x | y;</tspan></text></g></g></g></svg></figure><div slot=handle><i class="text-primary fa-sharp fa-solid fa-shield-cat fs-2"></i></div></img-comparison-slider><h2 id=when-to-use-it>When to use it?</h2><p>Arithmetic operations (<code>+, -, ^, &, |, ...</code>) are usually compiled into an AArch64 instruction that
<strong>exactly</strong> matches the original operation<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><p>For instance, when we compile this function in which the <code>xor</code> operation is considered sensitive,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>encode</span>(<span style=color:#8be9fd>uint8_t</span><span style=color:#ff79c6>*</span> data, size_t len) {
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>for</span> (size_t i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> len; <span style=color:#ff79c6>++</span>i) {
</span></span><span style=display:flex><span>    data[i] <span style=color:#ff79c6>=</span> data[i] <span style=color:#ff79c6>^</span> <span style=color:#bd93f9>0x23</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It results in this sequence of AArch64 instructions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-armasm data-lang=armasm><span style=display:flex><span>mov     <span style=color:#50fa7b>w10</span>, #<span style=color:#bd93f9>35</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>ldrb    <span style=color:#50fa7b>w11</span>, [<span style=color:#50fa7b>x9</span>]
</span></span><span style=display:flex;background-color:#3d3f4a><span>eor     <span style=color:#50fa7b>w11</span>, <span style=color:#50fa7b>w11</span>, <span style=color:#50fa7b>w10</span>
</span></span><span style=display:flex><span>strb    <span style=color:#50fa7b>w11</span>, [<span style=color:#50fa7b>x9</span>], #<span style=color:#bd93f9>1</span>
</span></span></code></pre></div><p>From a reverse engineering perspective, the sensitive xor operation associated with the <code>EOR</code> instruction is
straightforward to identify.</p><p>Thus, if you consider that the arithmetic operations performed by your function are sensitive, you
should consider enabling this obfuscation pass.</p><p>As a result, when this obfuscation pass is enabled, the previous operation is transformed into a
more complex expression:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#6272a4>// Transformation of data[i] = data[i] ^ 0x23;
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd>uint32_t</span> C <span style=color:#ff79c6>=</span> data[i];
</span></span><span style=display:flex><span><span style=color:#8be9fd>int32_t</span>  X <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>-</span>(C <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>0x23</span>);
</span></span><span style=display:flex><span>data[i] <span style=color:#ff79c6>=</span> ((C <span style=color:#ff79c6>+</span> (<span style=color:#bd93f9>0xffffffdc</span> <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>!</span>C) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>0x24</span>) <span style=color:#ff79c6>^</span> X) <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>          (((C <span style=color:#ff79c6>+</span> (<span style=color:#bd93f9>0xffffffdc</span> <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>!</span>C) <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>0x24</span>) <span style=color:#ff79c6>&amp;</span> X) <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#bd93f9>1</span>);
</span></span></code></pre></div><h2 id=how-to-use-it>How to use it?</h2><p>In the O-MVLL configuration file, you must define the following method in the Python class implementing <code>omvll.ObfuscationConfig</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>obfuscate_arithmetic</span>(self, mod: omvll<span style=color:#ff79c6>.</span>Module,
</span></span><span style=display:flex><span>                               fun: omvll<span style=color:#ff79c6>.</span>Function) <span style=color:#ff79c6>-&gt;</span> omvll<span style=color:#ff79c6>.</span>ArithmeticOpt:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> func<span style=color:#ff79c6>.</span>name <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#34;encode&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#6272a4># Explicitly define the number of iterations</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># applied on the arithmetic expressions</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> omvll<span style=color:#ff79c6>.</span>ArithmeticOpt(iterations<span style=color:#ff79c6>=</span><span style=color:#bd93f9>8</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> mod<span style=color:#ff79c6>.</span>name<span style=color:#ff79c6>.</span>endswith(<span style=color:#f1fa8c>&#34;encrypt.cpp&#34;</span>):
</span></span><span style=display:flex><span>        <span style=color:#6272a4># Obfuscate with a number of iteration defined by O-MVLL</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>False</span>
</span></span></code></pre></div><p>The <code>iteration</code> parameter defines the number of loops transforming the arithmetic operation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Operation : X ^ Y
</span></span><span style=display:flex><span>#1 Loop   : (X | Y) - (X &amp; Y)
</span></span><span style=display:flex><span>#2 Loop   : (((Y + X) - (Y &amp; X)) ^ ((Y | X) - (Y + X))) + 2*(((Y + X) - (Y &amp; X)) &amp; ((Y | X) - (Y + X)))
</span></span></code></pre></div><div class="alert d-flex alert-danger" role=alert style=max-width:1024px><i class="fa-light fa-shield-slash lead me-3"></i><div><p>It is more than <strong>highly recommended</strong> to run this pass with at least <strong>2 iterations</strong>.</p><p>See the next section for the details</p></div></div><h2 id=implementation>Implementation</h2><p>The transformation of the arithmetic operations works by iterating over all the instructions
of a basic block and selecting arithmetic operations (<code>+, -, ^, &, |</code>) that can be transformed with
a Mixed Boolean-Arithmetic expression:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#ff79c6>for</span> (Instruction<span style=color:#ff79c6>&amp;</span> <span style=color:#8be9fd;font-style:italic>I</span> : BasicBlock) {
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>auto</span><span style=color:#ff79c6>*</span> BinOp <span style=color:#ff79c6>=</span> dyn_cast<span style=color:#ff79c6>&lt;</span>BinaryOperator<span style=color:#ff79c6>&gt;</span>(<span style=color:#ff79c6>&amp;</span>I);
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (isSupported(<span style=color:#ff79c6>*</span>BinOp)) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Process ...
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In the first stage, the processing of the operation consists in extracting and wrapping the arithmetic operation (e.g. <code>add</code>)
with a function.</p><p>For instance, let&rsquo;s consider this addition:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#8be9fd>int</span> b <span style=color:#ff79c6>=</span> a <span style=color:#ff79c6>+</span> b;
</span></span></code></pre></div><p>After creating its wrapper, it becomes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>__omvll_add</span>(<span style=color:#8be9fd>int</span> x, <span style=color:#8be9fd>int</span> y) {
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>return</span> x <span style=color:#ff79c6>+</span> y;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> b <span style=color:#ff79c6>=</span> __omvll_add(x, y);
</span></span></code></pre></div><p><em>&ldquo;Why doing such transformation and not directly replacing the addition with its MBA equivalent?&rdquo;</em></p><p>First, LLVM is able to simplify MBA as it is discussed in the next section: <a href=#limitations--attacks>Limitation & Attacks</a>.
One solution to prevent these optimizations is to create a function flagged with the attribute <code>OptimizeNone</code>,
which is roughly equivalent to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-cpp data-lang=cpp><span style=display:flex;background-color:#3d3f4a><span>__attribute__((optnone))
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> __omvll_add(<span style=color:#8be9fd>int</span> x, <span style=color:#8be9fd>int</span> y) {
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>return</span> x <span style=color:#ff79c6>+</span> y;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class="alert d-flex alert-info" role=alert style=max-width:1024px><i class="fa-light fa-seal lead me-3"></i><div>As far I know, it does not exist an equivalent for basic blocks or instructions.</div></div><p>The second advantage of this call-transformation lies in the implementation of the iteration process.
If we perform the transformations on the arithmetic operations on the fly in the original basic block,
for each iteration, we must re-process all the other instructions of the basic block.</p><p>With a wrapper, it only requires applying the iterations on the isolated function, not on all the instructions
of the original basic block:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>__attribute__((optnone))
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> __omvll_add(<span style=color:#8be9fd>int</span> x, <span style=color:#8be9fd>int</span> y) {
</span></span><span style=display:flex><span>  E <span style=color:#ff79c6>=</span> x <span style=color:#ff79c6>+</span> y;
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>for</span> (size_t i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> NB_ITERATIONS; <span style=color:#ff79c6>++</span>i) {
</span></span><span style=display:flex><span>    E <span style=color:#ff79c6>=</span> MBA_add_xor_sub_or_and(E);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Last but not least, we have to make sure that the wrapped function is inlined at the end of the processing
otherwise, it would be a weakness.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>Wrapper<span style=color:#ff79c6>-&gt;</span>addFnAttr(Attribute<span style=color:#ff79c6>::</span>AlwaysInline);
</span></span></code></pre></div><p>This LLVM inlining code is equivalent to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-cpp data-lang=cpp><span style=display:flex><span>__attribute__((optnone))
</span></span><span style=display:flex;background-color:#3d3f4a><span>__attribute__((alwaysinline))
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> __omvll_add(<span style=color:#8be9fd>int</span> x, <span style=color:#8be9fd>int</span> y) {
</span></span><span style=display:flex><span>  E <span style=color:#ff79c6>=</span> x <span style=color:#ff79c6>+</span> y;
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>for</span> (size_t i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> NB_ITERATIONS; <span style=color:#ff79c6>++</span>i) {
</span></span><span style=display:flex><span>    E <span style=color:#ff79c6>=</span> MBA_add_xor_sub_or_and(E);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Regarding the transformations themselves, they rely on the built-in LLVM pattern matcher:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>Instruction<span style=color:#ff79c6>&amp;</span> I <span style=color:#ff79c6>=</span> ...;
</span></span><span style=display:flex><span>Value <span style=color:#ff79c6>*</span>X, <span style=color:#ff79c6>*</span>Y;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Match X &amp; Y
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>match(<span style=color:#ff79c6>&amp;</span>I, m_And(m_Value(X), m_Value(Y)))) {
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>nullptr</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Upon a match <i class="fa-sharp fa-regular fa-shield-heart text-secondary"></i>, the instruction associated
with the operation is replaced with a Mixed Boolean-Arithmetic expression (MBA):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#6272a4>// (X + Y) - (X | Y)
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>return</span> BinaryOperator<span style=color:#ff79c6>::</span>CreateSub(
</span></span><span style=display:flex><span>    Builder.CreateAdd(X, Y),
</span></span><span style=display:flex><span>    Builder.CreateOr(X, Y)
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>The overall structure of the <em>transformer</em> is highly inspired by the <a href=https://github.com/llvm/llvm-project/tree/17f2ee804a3c50f0b50d57a0100ce9f4102bfa3f/llvm/lib/Transforms/InstCombine>InstCombine</a> pass
and the MBA used in this pass are taken from <a href=https://github.com/quarkslab/sspam/blob/6784e1c06157c6984ef04b67382e584d4b5316e0/sspam/simplifier.py#L30-L53>sspam</a>
developed by Ninon Eyrolles:</p><table><thead><tr><th>Operation</th><th>MBA Transformation</th></tr></thead><tbody><tr><td><code>X ^ Y</code></td><td><code>(X | Y) - (X & Y)</code></td></tr><tr><td><code>X + Y</code></td><td><code>(X & Y) + (X | Y)</code></td></tr><tr><td><code>X - Y</code></td><td><code>(X ^ -Y) + 2*(X & -Y)</code></td></tr><tr><td><code>X & Y</code></td><td><code>(X + Y) - (X | Y)</code></td></tr><tr><td><code>X | Y</code></td><td><code>X + Y + 1 + (~X | ~Y)</code></td></tr></tbody></table><h2 id=limitations--attacks>Limitations & Attacks</h2><p>First and foremost, LLVM is able to <em>simplify</em> MBA as we can see in the file
<code>llvm/lib/Transforms/InstCombineAndOrXor.cpp</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#6272a4>// (A ^ B) ^ (A | C) --&gt; (~A &amp; C) ^ B -- There are 4 commuted variants.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>if</span> (match(<span style=color:#ff79c6>&amp;</span>I, m_c_Xor(m_OneUse(m_Xor(m_Value(A), m_Value(B))),
</span></span><span style=display:flex><span>                      m_OneUse(m_c_Or(m_Deferred(A), m_Value(C))))))
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> BinaryOperator<span style=color:#ff79c6>::</span>CreateXor(
</span></span><span style=display:flex><span>        Builder.CreateAnd(Builder.CreateNot(A), C), B);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// (A ^ B) ^ (B | C) --&gt; (~B &amp; C) ^ A -- There are 4 commuted variants.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>if</span> (match(<span style=color:#ff79c6>&amp;</span>I, m_c_Xor(m_OneUse(m_Xor(m_Value(A), m_Value(B))),
</span></span><span style=display:flex><span>                      m_OneUse(m_c_Or(m_Deferred(B), m_Value(C))))))
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> BinaryOperator<span style=color:#ff79c6>::</span>CreateXor(
</span></span><span style=display:flex><span>        Builder.CreateAnd(Builder.CreateNot(B), C), A);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// (A &amp; B) ^ (A ^ B) -&gt; (A | B)
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>if</span> (match(Op0, m_And(m_Value(A), m_Value(B))) <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span>    match(Op1, m_c_Xor(m_Specific(A), m_Specific(B))))
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>return</span> BinaryOperator<span style=color:#ff79c6>::</span>CreateOr(A, B);
</span></span><span style=display:flex><span><span style=color:#6272a4>// (A ^ B) ^ (A &amp; B) -&gt; (A | B)
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>if</span> (match(Op0, m_Xor(m_Value(A), m_Value(B))) <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span>    match(Op1, m_c_And(m_Specific(A), m_Specific(B))))
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>return</span> BinaryOperator<span style=color:#ff79c6>::</span>CreateOr(A, B);
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Hence, we must be careful to not trigger these simplifications (c.f. <a href=#implementation>Implementation</a>)</p><p>Second, the MBA currently used in this pass are:</p><ol><li>Fixed and statically encoded.</li><li>Simplified by the LLVM optimization pipeline if misconfigured.</li><li>Can be simplified with existing public tools once extracted.</li></ol><p>For the third point, <a href=https://github.com/mrphrazer/msynth>msynth</a> or <a href=https://triton-library.github.io/>Triton</a>
could be used to verify if the expressions are simplified.</p><p>Nevertheless, <strong>automatically</strong> identifying <strong>AND</strong> extracting MBAs from a compiled binary is not trivial
so we can consider that this pass introduces a non-negligible overhead for the reverse engineers.</p><p>For these reasons and, in its current form, this pass should be considered as a <em>cosmetic protection</em> rather
than a state-of-the-art protection.</p><h2 id=references>References</h2><div class="card card-body dark-mode border-0 shadow-sm position-relative overflow-hidden ps-sm-5 mb-5 mt-5"><div class="position-absolute top-0 start-0 w-3 h-100 bg-success"></div><div class="d-flex align-items-start border-bottom pb-3"><i class="fa-regular fa-books fs-xl text-success"></i><div class="ps-2 ms-1"><h6 class="opacity-80 mb-1">Publications</h6></div></div><div class=pt-3><div class="d-flex ps-3 align-items-start pb-3"><i class="fa-light fa-file-pdf fs-xl text-success me-4 mt-1"></i><div><h6 class="opacity-80 mb-1"><a href=https://arxiv.org/pdf/2209.06335 target=_blank>Efficient Deobfuscation of Linear Mixed Boolean-Arithmetic Expressions</a></h6><p class="fs-sm mb-0">by <i>Benjamin Reichenwallner, Peter Meerwald-Stadler</i></p></div></div><div class="d-flex ps-3 align-items-start pb-3"><i class="fa-light fa-link fs-xl text-success me-4 mt-1"></i><div><h6 class="opacity-80 mb-1"><a href=https://secret.club/2022/08/08/eqsat-oracle-synthesis.html target=_blank>Improving MBA Deobfuscation using Equality Saturation</a></h6><p class="fs-sm mb-0">by <i>Matteo Favaro, Tim Blazytko</i></p></div></div><div class="d-flex ps-3 align-items-start pb-3"><i class="fa-light fa-presentation-screen fs-xl text-success me-4 mt-1"></i><div><h6 class="opacity-80 mb-1"><a href=https://i.blackhat.com/USA21/Wednesday-Handouts/US-21-David-Greybox-Program-Synthesis.pdf target=_blank>Greybox Program Synthesis: A New Approach to Attack Dataflow Obfuscation</a></h6><p class="fs-sm mb-0">by <i>Robin David</i></p></div></div><div class="d-flex ps-3 align-items-start pb-3"><i class="fa-light fa-file-pdf fs-xl text-success me-4 mt-1"></i><div><h6 class="opacity-80 mb-1"><a href=https://i.blackhat.com/USA21/Wednesday-Handouts/US-21-David-Greybox-Program-Synthesis-wp.pdf target=_blank>Greybox Program Synthesis: A New Approach to Attack Dataflow Obfuscation</a></h6><p class="fs-sm mb-0">by <i>Robin David</i></p></div></div><div class="d-flex ps-3 align-items-start pb-3"><i class="fa-light fa-file-pdf fs-xl text-success me-4 mt-1"></i><div><h6 class="opacity-80 mb-1"><a href=https://archive.bar/pdfs/bar2020-preprint9.pdf target=_blank>QSynth - A Program Synthesis based Approach for Binary Code Deobfuscation</a></h6><p class="fs-sm mb-0">by <i>Robin David, Luigi Coniglio, Mariano Ceccato</i></p></div></div><div class="d-flex ps-3 align-items-start pb-3"><i class="fa-light fa-book-atlas fs-xl text-success me-4 mt-1"></i><div><h6 class="opacity-80 mb-1"><a href=https://tel.archives-ouvertes.fr/tel-01623849 target=_blank>Obfuscation with Mixed Boolean-Arithmetic Expressions : reconstruction, analysis and simplification tools</a></h6><p class="fs-sm mb-0">by <i>Ninon Eyrolles</i></p></div></div><div class="d-flex ps-3 align-items-start pb-3"><i class="fa-light fa-link fs-xl text-success me-4 mt-1"></i><div><h6 class="opacity-80 mb-1"><a href=https://blog.quarkslab.com/arybo-cleaning-obfuscation-by-playing-with-mixed-boolean-and-arithmetic-operations.html target=_blank>Arybo: cleaning obfuscation by playing with mixed boolean and arithmetic operations</a></h6><p class="fs-sm mb-0">by <i>Adrien Guinet</i></p></div></div></div><div class="d-flex align-items-start border-bottom pb-3"><i class="fa-regular fa-atom fs-xl text-success"></i><div class="ps-2 ms-1"><h6 class="opacity-80 mb-1">Tools</h6></div></div><div class=pt-3><div class="d-flex ps-3 align-items-start pb-3"><i class="fa-light fa-brands fa-github-alt fs-xl text-success me-4 mt-1"></i><div><h6 class="opacity-80 mb-1"><a href=https://github.com/mrphrazer/msynth target=_blank>msynth</a></h6><p class="fs-sm mb-0">by <i>Tim Blazytko</i></p></div></div><div class="d-flex ps-3 align-items-start pb-3"><i class="fa-light fa-brands fa-github-alt fs-xl text-success me-4 mt-1"></i><div><h6 class="opacity-80 mb-1"><a href=https://github.com/quarkslab/qsynthesis target=_blank>qsynthesis</a></h6><p class="fs-sm mb-0">by <i>Robin David</i></p></div></div></div><div class="d-flex align-items-start border-bottom pb-3"><i class="fa-regular fa-clapperboard-play fs-xl text-success"></i><div class="ps-2 ms-1"><h6 class="opacity-80 mb-1">Talks</h6></div></div><div class=pt-3><div class="d-flex ps-3 align-items-start pb-3"><i class="fa-brands fa-youtube fs-xl text-success me-4 mt-1"></i><div><h6 class="opacity-80 mb-1"><a href="https://www.youtube.com/watch?v=eJo74i7nxtk" target=_blank>Greybox Program Synthesis: A New Approach to Attack Dataflow Obfuscation</a></h6><p class="fs-sm mb-0">by <i>Robin David</i></p></div></div><div class="d-flex ps-3 align-items-start pb-3"><i class="fa-brands fa-youtube fs-xl text-success me-4 mt-1"></i><div><h6 class="opacity-80 mb-1"><a href="https://www.youtube.com/watch?v=5yDzbFz2yWo" target=_blank>Advanced Code Obfuscation With MBA Expressions</a></h6><p class="fs-sm mb-0">by <i>Arnau Gàmez Montolio</i></p></div></div></div><div class="d-flex align-items-start border-bottom pb-3"><i class="fa-regular fa-dagger fs-xl text-success"></i><div class="ps-2 ms-1"><h6 class="opacity-80 mb-1">Attacks</h6></div></div><div class=pt-3><div class="d-flex ps-3 align-items-start pb-3"><i class="fa-solid fa-file-code fs-xl text-success me-4 mt-1"></i><div><h6 class="opacity-80 mb-1"><a href=https://github.com/fvrmatteo/oracle-synthesis-meets-equality-saturation target=_blank>Oracle Synthesis Meets Equality Saturation</a></h6><p class="fs-sm mb-0"><i>PoC associated with the blog post: 'Improving MBA Deobfuscation using Equality Saturation'.</i></p></div></div></div></div><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>The compiler might also optimize the operation into instructions that are equivalent but
less meaningful from a reverse engineering perspective. For instance, <code>x % 8</code> is usually transformed in <code>x & 7</code>.
<a href=https://www.oreilly.com/library/view/hackers-delight-second/9780133084993/>Hacker&rsquo;s Delight</a> is a good
reference for this kind of transformation.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></div><nav class=pb-5><ul class="pagination d-flex justify-content-left"><li class=page-item><a href=https://obfuscator.re/omvll/passes/anti-hook/ class=page-link><i class="fa-regular fa-chevrons-left ms-n1 me-1 fs-xs"></i>
Anti-Hooking</a></li><li class=page-item><a href=https://obfuscator.re/omvll/passes/control-flow-breaking/ class=page-link>Control-Flow Breaking
<i class="fa-regular fa-chevrons-right me-n1 ms-1 fs-xs"></i></a></li></ul></nav></main><aside id=jumpToNav class="side-nav side-nav-end d-none d-xxl-block position-fixed top-0 end-0 vh-100 py-5" style=width:20rem><h3 class="fs-lg mt-5 pt-5">Jump to</h3><ul class=nav><li class=nav-item><a class=nav-link href=#when-to-use-it data-scroll data-scroll-offset=-6>When to use it?</a></li><li class=nav-item><a class=nav-link href=#how-to-use-it data-scroll data-scroll-offset=-6>How to use it?</a></li><li class=nav-item><a class=nav-link href=#implementation data-scroll data-scroll-offset=-6>Implementation</a></li><li class=nav-item><a class=nav-link href=#limitations--attacks data-scroll data-scroll-offset=-6>Limitations & Attacks</a></li><li class=nav-item><a class=nav-link href=#references data-scroll data-scroll-offset=-6>References</a></li></ul></aside></main><footer class="footer dark-mode bg-dark pt-5 pb-4 pb-lg-5"><div class="container text-center pt-lg-3"><p class="nav d-block fs-sm text-center pt-5 mt-lg-4 mb-0"><span class="text-light opacity-50">Site generated with</span>
<a class="nav-link d-inline-block p-0" href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a>
<span class="text-light opacity-50">and created by</span>
<a class="nav-link d-inline-block p-0" href=https://www.romainthomas.fr/ target=_blank rel=noopener>R. Thomas</a></p></div></footer><noscript><div class="navbar navbar-expand-lg navbar-dark shadow-sm fixed-bottom d-flex justify-content-center align-items-center"><div class="alert alert-warning fade show" role=alert><i class="fa-solid fa-gingerbread-man me-2"></i>
This website is free from cookies, trackers, and ads but you might want to enable javascript for a
better UI experience.</div></div></noscript><script src=/vendor/bootstrap/dist/js/bootstrap.bundle.min.js></script>
<script src=/vendor/smooth-scroll/dist/smooth-scroll.polyfills.min.js></script>
<script src=/vendor/parallax-js/dist/parallax.min.js></script>
<script src=/vendor/jarallax/dist/jarallax.min.js></script>
<script src=/vendor/rellax/rellax.min.js></script>
<script src=/vendor/swiper/swiper-bundle.min.js></script>
<script src=/vendor/lightgallery/lightgallery.min.js></script>
<script src=/vendor/lightgallery/plugins/video/lg-video.min.js></script>
<script>jarallax(document.querySelectorAll(".jarallax"),{speed:.2})</script><script src=/vendor/img-comparison-slider/dist/index.js></script>
<script src=/js/theme.min.js></script>
<script src=/js/anime.min.js></script></body></html>