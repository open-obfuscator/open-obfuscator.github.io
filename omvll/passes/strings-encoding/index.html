<!doctype html><html class=dark-mode lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=manifest href=manifest.webmanifest><link rel=icon type=image/svg+xml href=/favicon/favicon.svg><link rel=icon type=image/png href=/favicon/favicon_hue529d2a9513ea41889fd87b18b80b0ed_11211_32x32_fill_box_center_3.png><link rel="shortcut icon" type=image/png href=/favicon/favicon_hue529d2a9513ea41889fd87b18b80b0ed_11211_192x192_fill_box_center_3.png><link rel=apple-touch-icon type=image/png href=/favicon/favicon_hue529d2a9513ea41889fd87b18b80b0ed_11211_192x192_fill_box_center_3.png><meta name=description content="This pass can be used to obfuscate program's strings"><meta property="og:type" content="website"><meta property="og:description" content="This pass can be used to obfuscate program's strings"><meta property="og:title" content="Strings Encoding | Open Obfuscator: A free and open-source solution for obfuscating mobile applications."><meta property="og:site_name" content="Open Obfuscator: A free and open-source solution for obfuscating mobile applications."><meta property="og:url" content="https://obfuscator.re/omvll/passes/strings-encoding/"><meta property="og:locale" content="en-us"><meta property="article:modified_time" content="2022-09-07T06:41:10+02:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@open_obfuscator"><meta name=twitter:creator content="@rh0main"><meta name=twitter:title content="Strings Encoding | Open Obfuscator: A free and open-source solution for obfuscating mobile applications."><meta name=twitter:description content="This pass can be used to obfuscate program's strings"><meta name=twitter:domain content="https://obfuscator.re/omvll/passes/strings-encoding/"><title>Strings Encoding | O-MVLL Documentation</title><link rel=canonical href=https://obfuscator.re/omvll/passes/strings-encoding/><link rel=stylesheet href=/css/fa-all.min.css><link rel=stylesheet href=/vendor/swiper/swiper-bundle.min.css><link rel=stylesheet href=/vendor/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/vendor/img-comparison-slider/dist/styles.css><link rel=stylesheet href=/css/theme.min.css></head><body><main class=page-wrapper><header class="header navbar navbar-expand bg-light border-bottom border-light shadow fixed-top" data-scroll-header><div class="container-fluid pe-lg-4"><div class="d-flex align-items-center px-4"><a href=https://obfuscator.re/omvll/passes/ class="navbar-brand flex-shrink-0 py-1 py-lg-2">O-MVLL</a></div><div class="d-flex align-items-center w-100"><ul class="navbar-nav d-none d-lg-flex" style=padding-left:11.75rem><li class=nav-item><a href=https://github.com/open-obfuscator/o-mvll target=_blank class=nav-link><i class="fa-brands fa-github opacity-70 fs-lg me-1"></i>
&nbsp;Source Code</a></li><li class=nav-item><a href=https://github.com/open-obfuscator/o-mvll/releases/ target=_blank class=nav-link><i class="fa-solid fa-download opacity-70 fs-lg me-1"></i>
&nbsp;Download</a></li></ul><button type=button class="navbar-toggler d-block d-lg-none ms-auto me-4" data-bs-toggle=offcanvas data-bs-target=#docsNav aria-controls=docsNav aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="form-check form-switch mode-switch pe-lg-1 ms-lg-auto" data-bs-toggle=obfuscator><input type=checkbox class="form-check-input mt-1" id=which-obfuscator checked>
<label class="form-check-label d-none d-sm-block d-lg-none d-xl-block text-gradient-dprotect" for=theme-mode><strong>dProtect</strong></label>
<label class="form-check-label d-none d-sm-block d-lg-none d-xl-block text-gradient-omvll" for=theme-mode><strong>O-MVLL</strong></label></div><a href=https://obfuscator.re/ class="btn btn-primary btn-sm fs-sm rounded ms-4 d-none d-lg-inline-flex"><i class="fa-sharp fa-solid fa-house-heart fs-5 lh-1 me-1"></i>
&nbsp;Home</a></div></div></header><aside class=dark-mode><div id=docsNav class="offcanvas-lg offcanvas-start d-flex flex-column position-fixed top-0 start-0 vh-100 bg-dark border-end-lg" style=width:21rem;z-index:1045><div class="offcanvas-header d-none d-lg-flex justify-content-start"><a href=/omvll/ class="navbar-brand text-dark d-none d-lg-flex py-0"><svg xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" width="26.456686" height="26.974693" viewBox="0 0 6.9999978 7.1370545" id="svg20282" sodipodi:docname="omvll.svg"><sodipodi:namedview id="namedview20284" pagecolor="#ffffff" bordercolor="#000000" borderopacity=".25" showgrid="false"/><defs id="defs20279"/><g id="layer1" transform="translate(-2.7177092,-2.2523059)"><g id="g34542" transform="matrix(0.01393956,0,0,0.01393956,2.6491795,2.252306)" style="font-size:80px;font-family:brolink demo;-inkscape-font-specification:'Brolink DEMO, Normal';display:inline;opacity:.778276;stroke-width:37.9613;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:2;stroke-dasharray:4.79781,9.59564"><g id="g34508" style="stroke-width:37.9613"><path d="m162.144 193.719s67.743-16.576 50.853-114.74c0 0 81.408-135.816 257.901-50.836.0.0-114.839 23.251-86.081 138.61.0.0-77.272-16.404-96.43 49.396.0.0-39.238-26.305-76.384 13.254.001.0-31.497 4.809-49.859-35.684z" fill="#5bc992" id="path34504" style="fill:#0d3758;fill-opacity:1;stroke-width:258.859"/><path d="m168.14 196.604c-3.557.0-6.756-2.472-7.539-6.09-.898-4.15 1.723-8.243 5.861-9.168 1.823-.428 42.24-10.743 40.627-79.558-.229-9.782-1.411-20.039-3.511-30.485l-2.197-10.93c-.84-4.18 1.868-8.251 6.048-9.092 4.184-.838 8.251 1.868 9.092 6.048l2.197 10.93c2.277 11.327 3.559 22.486 3.81 33.167.547 23.372-3.317 55.876-24.841 77.998-13.361 13.732-27.318 16.877-27.906 17.004-.55.118-1.1.176-1.641.176z" fill="#0bb494" id="path34506" style="fill:#59aae8;fill-opacity:.992157;stroke-width:258.859"/></g><g id="g34514" style="stroke-width:37.9613"><path d="m230.826 252.7c40.616-35.987 77.278-6.195 77.278-6.195 25.11-63.766 100.553-40.346 100.553-40.346-18.06-117.51 98.427-130.134 98.427-130.134-167.958-100.804-261.476 26.976-261.476 26.976 7.818 99.299-61.159 109.594-61.159 109.594s10.647 24.683 46.377 40.105z" fill="#6fd7a3" id="path34510" style="fill:#135587;fill-opacity:1;stroke-width:258.859"/><path d="m190.86 216.05c-3.848.0-7.177-2.872-7.655-6.788-.514-4.215 2.472-8.051 6.676-8.593 1.85-.258 43.048-6.821 47.752-75.499.668-9.759.432-20.08-.702-30.678l-1.186-11.085c-.453-4.24 2.616-8.046 6.856-8.499 4.242-.449 8.046 2.616 8.499 6.856l1.186 11.085c1.23 11.492 1.483 22.721.753 33.377-1.598 23.324-8.426 55.337-31.888 75.392-14.564 12.449-28.751 14.301-29.348 14.374-.316.039-.631.058-.943.058z" fill="#0bb494" id="path34512" style="fill:#59aae8;fill-opacity:.992157;stroke-width:258.859"/></g><path d="m99.22 32.25c54.02-16.304 94.124 31.976 82.031 97.634-11.942 64.843 13.555 101.705 49.575 122.816 34.936 20.476 92.97 61.763 97.24 138.002 7.207 128.69-146.88 153.812-189.774 79.616-38.092-65.889 25.07-126.332 25.07-126.332l15.768 13.085s-54.212 57.459-6.717 98.644c41.377 35.88 119.62 4.994 94.473-63.798-22.727-62.169-113.186-48.785-155.96-107.49C70.063 228.345 104.751 176.066 120.847 144.993c26.901-51.934 11.207-94.471-22.844-80.767z" fill="#c9f6b0" id="path34516" style="fill:#1b71af;fill-opacity:1;stroke-width:258.859"/><g id="g34520" style="stroke-width:37.9613"><path d="M328.066 390.702C323.797 314.463 265.762 273.176 230.826 252.7c-36.02-21.111-61.517-57.973-49.575-122.816C193.344 64.227 153.24 15.946 99.22 32.25l-.016.427c31.181 11.593 49.582 49.885 40.867 97.207-11.942 64.843 13.555 101.705 49.575 122.816 34.936 20.476 92.97 61.763 97.24 138.002 3.97 70.889-41.004 110.348-89.374 119.094 59.897 11.218 135.657-27.974 130.554-119.094z" fill="#bbf49b" id="path34518" style="fill:#155d91;fill-opacity:1;stroke-width:258.859"/></g><path d="M86.13 29.061 146.528.0s-10.295 53.02-52.157 74.817L75.834 69.492z" fill="#6fd7a3" id="path34522" style="fill:#0cf;fill-opacity:1;stroke-width:258.859"/><path d="m108.988.0-14.942 49.333.325 25.484c.132 10.356-5.648 19.894-14.922 24.625l-53.66 27.374C13.17 133.254-.159 119.45 6.856 107.202c8.309-14.507 17.855-31.646 27.245-49.53C41.851 42.911 53.79 30.729 68.409 22.59z" fill="#c9f6b0" id="path34524" style="fill:#2a95e1;fill-opacity:1;stroke-width:258.859"/><path d="m181.814 315.601c4.614-3.907 11.558.252 10.29 6.164l-6.293 29.354-7.207 33.619c-1.15 5.364-8.11 6.832-11.328 2.389L157.07 373.035c-1.033-1.427-2.614-2.359-4.362-2.573l-16.799-2.056c-5.486-.672-7.543-7.554-3.325-11.126l26.177-22.163z" fill="#6fd7a3" id="path34526" style="fill:#2ad4ff;fill-opacity:.992157;stroke-width:258.859"/><path d="m408.662 213.882c-2.855.0-5.599-1.59-6.939-4.325-.083-.168-8.514-17.05-27.948-36.153-17.846-17.542-48.949-40.642-95.775-51.077-4.162-.927-6.784-5.054-5.857-9.216.927-4.162 5.05-6.787 9.216-5.857 50.722 11.302 84.422 36.5 103.761 55.648 21.095 20.887 30.105 39.107 30.478 39.872 1.869 3.833.277 8.455-3.556 10.324-1.091.533-2.244.784-3.38.784z" fill="#0bb494" id="path34528" style="fill:#59aae8;fill-opacity:.992157;stroke-width:258.859"/><path d="m308.106 254.226c-.035.0-.068.0-.103-.001-4.254-.056-7.66-3.541-7.62-7.792.0-.459-.233-27.156-22.522-73.746-1.84-3.847-.214-8.457 3.633-10.298s8.457-.214 10.298 3.633c24.143 50.465 24.049 79.377 24.033 80.583-.056 4.231-3.502 7.621-7.719 7.621z" fill="#0bb494" id="path34530" style="fill:#59aae8;fill-opacity:.992157;stroke-width:258.859"/><g fill="#6fd7a3" id="g34540" style="display:inline;stroke-width:258.859"><path d="m293.41 353.127c-2.935.0-5.74-1.682-7.034-4.528-1.765-3.882-.048-8.459 3.834-10.224 6.955-3.161 18.792-10.715 18.911-10.791 3.592-2.297 8.368-1.248 10.665 2.345s1.248 8.367-2.345 10.665c-.522.334-12.881 8.222-20.84 11.839-1.036.47-2.122.694-3.191.694z" id="path34532" style="fill:#2b97e2;fill-opacity:.992157;stroke-width:37.9613"/><path d="m308.098 407.232c-4.104.0-7.52-3.231-7.707-7.372-.193-4.26 3.104-7.87 7.364-8.063l20.207-.915c4.259-.189 7.87 3.104 8.063 7.364s-3.104 7.87-7.364 8.063l-20.207.915c-.119.005-.238.008-.356.008z" id="path34534" style="fill:#2b97e2;fill-opacity:.992157;stroke-width:37.9613"/><path d="m310.641 470.991c-1.381.0-2.779-.37-4.042-1.148l-14.183-8.736c-3.631-2.236-4.762-6.993-2.525-10.623 2.236-3.632 6.993-4.762 10.623-2.525l14.184 8.736c3.631 2.236 4.762 6.993 2.525 10.623-1.459 2.368-3.99 3.673-6.582 3.673z" id="path34536" style="fill:#2b97e2;fill-opacity:.992157;stroke-width:37.9613"/><path d="m258.788 512c-2.901.0-5.679-1.642-6.994-4.441l-7.245-15.427c-1.813-3.86-.153-8.458 3.707-10.271 3.858-1.813 8.458-.153 10.271 3.707l7.245 15.427c1.813 3.86.153 8.458-3.707 10.271-1.06.498-2.177.734-3.277.734z" id="path34538" style="fill:#2b97e2;fill-opacity:.992157;stroke-width:37.9613"/></g></g></g></svg></a><span class="badge bg-omvll d-none d-lg-inline-block"><strong>O-MVLL</strong></span></div><div class="offcanvas-header d-block d-lg-none border-bottom"><div class="d-flex align-items-center justify-content-between mb-3"><h5 class="d-lg-none mb-0">Menu</h5><button type=button class="btn-close d-lg-none" data-bs-dismiss=offcanvas data-bs-target=#docsNav></button></div><div class="list-group list-group-flush mx-n4"><a href=https://github.com/open-obfuscator/o-mvll target=_blank class="list-group-item list-group-item-action d-flex align-items-center border-0 py-2 px-4"><i class="fa-brands fa-github fs-lg opacity-80 me-2"></i>
Source Code</a>
<a href=https://github.com/open-obfuscator/o-mvll/releases/ target=_blank class="list-group-item list-group-item-action d-flex align-items-center border-0 py-2 px-4"><i class="fa-solid fa-download fs-lg opacity-80 me-2"></i>
Download</a></div></div><div class="offcanvas-body p-4"><div class=swiper-wrapper><div class="swiper-slide h-auto"><h3 class=fs-lg><a href=https://obfuscator.re/omvll/introduction/>Introduction</a></h3><div class="list-group list-group-flush mx-n4 pb-2"><a href=https://obfuscator.re/omvll/introduction/getting-started/ class="list-group-item list-group-item-action border-0 py-2 px-4">Getting started</a>
<a href=https://obfuscator.re/omvll/introduction/compilation/ class="list-group-item list-group-item-action border-0 py-2 px-4">Compilation</a>
<a href=https://open-obfuscator.github.io/o-mvll target=_blank class="list-group-item list-group-item-action border-0 py-2 px-4">API</a></div><h3 class=fs-lg><a href=https://obfuscator.re/omvll/passes/>Obfuscation Passes</a></h3><div class="list-group list-group-flush mx-n4 pb-2"><a href=https://obfuscator.re/omvll/passes/anti-hook/ class="list-group-item list-group-item-action border-0 py-2 px-4"><span class="fa-regular fa-tachograph-digital me-2"></span>
Anti-Hooking</a>
<a href=https://obfuscator.re/omvll/passes/arithmetic/ class="list-group-item list-group-item-action border-0 py-2 px-4"><span class="fa-regular fa-calculator-simple me-2"></span>
Arithmetic Obfuscation</a>
<a href=https://obfuscator.re/omvll/passes/control-flow-breaking/ class="list-group-item list-group-item-action border-0 py-2 px-4"><span class="fa-regular fa-chart-tree-map me-2"></span>
Control-Flow Breaking</a>
<a href=https://obfuscator.re/omvll/passes/control-flow-flattening/ class="list-group-item list-group-item-action border-0 py-2 px-4"><span class="fa-regular fa-cubes-stacked me-2"></span>
Control-Flow Flattening</a>
<a href=https://obfuscator.re/omvll/passes/objcleaner/ class="list-group-item list-group-item-action border-0 py-2 px-4"><span class="fa-brands fa-apple me-2"></span>
Objective-C Cleaner</a>
<a href=https://obfuscator.re/omvll/passes/opaque-constants/ class="list-group-item list-group-item-action border-0 py-2 px-4"><span class="fa-regular fa-input-numeric me-2"></span>
Opaque Constants</a>
<a href=https://obfuscator.re/omvll/passes/opaque-fields-access/ class="list-group-item list-group-item-action border-0 py-2 px-4"><span class="fa-regular fa-arrow-right me-2"></span>
Opaque Fields Access</a>
<a href=https://obfuscator.re/omvll/passes/strings-encoding/ class="list-group-item list-group-item-action border-0 py-2 px-4 active"><span class="fa-regular fa-square-a-lock me-2"></span>
Strings Encoding</a></div><h3 class=fs-lg><a href=https://obfuscator.re/omvll/other-topics/>Other Topics</a></h3><div class="list-group list-group-flush mx-n4 pb-2"><a href=https://obfuscator.re/omvll/other-topics/troubleshooting/ class="list-group-item list-group-item-action border-0 py-2 px-4">Troubleshooting</a>
<a href=https://obfuscator.re/omvll/other-topics/jit/ class="list-group-item list-group-item-action border-0 py-2 px-4">LLVM JIT</a>
<a href=https://obfuscator.re/omvll/other-topics/annotations/ class="list-group-item list-group-item-action border-0 py-2 px-4">Obfuscation Annotations</a></div></div></div><div class="swiper-scrollbar end-0"></div></div><div class="offcanvas-header border-top"><a href=https://obfuscator.re/ class="btn btn-primary w-100" target=_blank rel=noopener><i class="fa-sharp fa-solid fa-house-heart fs-4 lh-1 me-1"></i>
&nbsp;Home</a></div></div></aside><main class="docs-container pt-5 pb-3 pb-lg-4"><div class="container-fluid px-xxl-5 px-lg-4 pt-4 pt-lg-5 pb-4"><section class="container ms-0"><div class=row><aside class="col-lg-4 col-md-5 offset-xl-1 order-md-2 mb-5"><div style=margin-top:-96px></div><div class="position-sticky top-0 pt-5"><div class="pt-5 mt-md-3"><div class="card shadow-sm p-sm-3"><div class=card-body><h4 class=mb-4>Summary</h4><ul class=list-unstyled><li class="d-flex align-items-center mb-2"><i class="fa-light fa-shield fs-xl text-muted me-2 pe-1"></i>
<strong class=me-2>Protection:</strong><div class="d-flex align-items-center"><span class="badge bg-info me-1">Static</span></div></li><li class="d-flex align-items-center mb-2"><i class="fa-light fa-circle-nodes fs-xl text-muted me-2 pe-1"></i>
<strong class=me-1>Resilience:</strong> Medium</li><li class="d-flex align-items-center mb-2"><i class="fa-light fa-gear fs-xl text-muted me-2 pe-1"></i>
<strong class=me-1>Overhead:</strong> Depends</li><li class="d-flex align-items-center mb-2"><i class="fa-light fa-user-secret fs-xl text-muted me-2 pe-1"></i>
<strong class=me-1>Public Attacks:</strong> Yes</li></ul><a href=https://github.com/open-obfuscator/o-mvll/tree/main/src/passes/strings-encoding target=_blank class="btn btn-primary btn shadow-primary"><span class="fa-brands fa-github fs-xl me-3"></span>Source Code</a></div></div></div></div></aside><div class="col-xl-7 col-lg-8 col-md-7 order-md-1 mb-5 hugo-generated omvll"><h1 id=strings-encoding><i class="fa-regular fa-square-a-lock me-1"></i> Strings Encoding</h1><div class="alert d-flex alert-success" role=alert><i class="fa-solid fa-shield-cat lead me-3"></i><div>The purpose of the pass is to protect strings from a static analysis.</div></div><p>Strings, along with constants and symbols, are the kind of information that are quickly accessible
and very efficient in reverse engineering to guess or infer the purpose of a function.</p><p>In addition, some macros like <code>__FILE__</code> might also leak information about the original filename which
is also a valuable information.
If this macro is used in a header coming from a third-party SDK you might not be aware of this leak.</p><p>O-MVLL provides a modular configuration API to protect these information with different levels of protection.</p><h2 id=how-to-use-it>How to use it?</h2><p>First, let&rsquo;s start with removing unwanted strings. If we consider the following function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#ff79c6>#define LOG_ERROR(MSG) fprintf(stderr,&#34;Error: %s (%s:%d)\n&#34;, MSG, __FILE__, __LINE__)
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>bool</span> <span style=color:#50fa7b>check_code</span>(<span style=color:#8be9fd>int</span> code) {
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (code <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>47839</span>) {
</span></span><span style=display:flex><span>    LOG_ERROR(<span style=color:#f1fa8c>&#34;Wrong input&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>false</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>true</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We can observe a leak of the original filename in the compiled binary:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ strings ./strings.bin
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>libc.so
</span></span><span style=display:flex><span>LIBC
</span></span><span style=display:flex><span>libdl.so
</span></span><span style=display:flex><span>libm.so
</span></span><span style=display:flex><span>/home/romain/dev/o-mvll/tests/strings.cpp
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>To remove this unwanted string, we first need &ndash; as for all the obfuscation passes &ndash; to define the
associated function, <code>obfuscate_string</code>, in the configuration class:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>                           <span style=color:#6272a4># LLVM module where the string is referenced</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>obfuscate_string</span>(self, mod: omvll<span style=color:#ff79c6>.</span>Module,
</span></span><span style=display:flex><span>                           <span style=color:#6272a4># Function that uses the string</span>
</span></span><span style=display:flex><span>                           func: omvll<span style=color:#ff79c6>.</span>Function,
</span></span><span style=display:flex><span>                           <span style=color:#6272a4># The string itself as a Python bytes object</span>
</span></span><span style=display:flex><span>                           string: <span style=color:#8be9fd;font-style:italic>bytes</span>):
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>pass</span>
</span></span></code></pre></div><p>If the function <code>obfuscate_string</code> returns a string, then the original string
is replaced with the string returned. In our example, the original filename could be removed with this code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>obfuscate_string</span>(self, _, __, string: <span style=color:#8be9fd;font-style:italic>bytes</span>):
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> string<span style=color:#ff79c6>.</span>startswith(<span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#34;/home&#34;</span>) <span style=color:#ff79c6>and</span> string<span style=color:#ff79c6>.</span>endswith(<span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#34;.cpp&#34;</span>):
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;REDACTED&#34;</span>
</span></span></code></pre></div><div class="alert d-flex alert-danger" role=alert style=max-width:1024px><i class="fa-regular fa-bug lead me-3"></i><div>The input parameter string is a <strong>bytes</strong> object. Thus if we compare
with a Python <strong>str</strong> object, it will be always false (like: <code>string.endswith(".cpp")</code>)</div></div><p>The redacted string can be confirmed in the decompiled output:</p><figure class=figure><img-comparison-slider class=omvll><figure slot=first class=position-relative><img src=img/leak.webp></figure><figure slot=second class=position-relative><img src=img/redacted.webp></figure><div slot=handle><i class="text-primary fa-sharp fa-solid fa-shield-cat fs-2"></i></div></img-comparison-slider></figure><p>Let&rsquo;s now consider that instead of removing a string, we want to protect it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#8be9fd>bool</span> <span style=color:#50fa7b>check_code</span>(<span style=color:#8be9fd>int</span> code) {
</span></span><span style=display:flex;background-color:#3d3f4a><span>  <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> BANNER[] <span style=color:#ff79c6>=</span> R<span style=color:#f1fa8c>&#34;delim(</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>  Hello gentle reverser,
</span></span><span style=display:flex;background-color:#3d3f4a><span>  You are asked to enter the correct input that resolves <span style=color:#ff79c6>this</span> function.
</span></span><span style=display:flex;background-color:#3d3f4a><span>  Thank you<span style=color:#ff79c6>!</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>  )delim<span style=color:#f1fa8c>&#34;;</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>  printf(<span style=color:#f1fa8c>&#34;%s</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, BANNER);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (code <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>47839</span>) {
</span></span><span style=display:flex><span>    LOG_ERROR(<span style=color:#f1fa8c>&#34;Wrong input&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>false</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>true</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In this updated version of <code>check_code()</code>, the function prints a message that aims
to be protected. Since this string is <strong>large</strong> and <strong>not really sensitive</strong>,
it is recommended to protect this string with the O-MVLL option: <code>StringEncOptGlobal()</code>.</p><div class="alert d-flex alert-info" role=alert style=max-width:1024px><i class="fa-light fa-list-tree lead me-3"></i><div>All the options accepted by this function are synthesized at the end of this section</div></div><p>We can trigger this kind of protection as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>obfuscate_string</span>(self, _, __, string: <span style=color:#8be9fd;font-style:italic>bytes</span>):
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> string<span style=color:#ff79c6>.</span>startswith(<span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#34;/home&#34;</span>) <span style=color:#ff79c6>and</span> string<span style=color:#ff79c6>.</span>endswith(<span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#34;.cpp&#34;</span>):
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;REDACTED&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>    <span style=color:#ff79c6>if</span> <span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#34;Hello gentle reverse&#34;</span> <span style=color:#ff79c6>in</span> string:
</span></span><span style=display:flex;background-color:#3d3f4a><span>        <span style=color:#ff79c6>return</span> omvll<span style=color:#ff79c6>.</span>StringEncOptGlobal()
</span></span></code></pre></div><p>With this option, the original string is encoded and stored in the <code>.data</code> section of the binary.
<strong>As soon as</strong> the binary is loaded, the string is decoded <strong>in place</strong> by a constructor function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> BANNER[] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\xD4\x24</span><span style=color:#f1fa8c>...&#34;</span>
</span></span><span style=display:flex><span>__attribute__((constructor))
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> decode() {
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// Decode the BANNER encoded buffer
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>bool</span> <span style=color:#50fa7b>check_code</span>(<span style=color:#8be9fd>int</span> code) {
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  printf(<span style=color:#f1fa8c>&#34;%s</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, BANNER);
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class="card card-body dark-mode border-0 shadow-sm position-relative overflow-hidden ps-sm-5 mb-5 mt-5"><div class="position-absolute top-0 start-0 w-3 h-100 bg-info"></div><div class="d-flex align-items-start border-bottom pb-3"><i class="fa-regular fa-circle-info fs-xl text-info"></i><div class="ps-2 ms-1"><h6 class="opacity-80 mb-1">Performances & Overhead</h6></div></div><div class=pt-3><div class="d-flex align-items-start pb-3"><div><p><code>StringEncOptGlobal</code> is the option that produces the least overhead in terms of code size
and execution time.</p><p>On the other hand, the clear string is present in memory as soon as the binary is loaded
which makes it easily accessible through a memory dump. This limitation is discussed in the section
<a href=#limitations>Limitations</a></p></div></div></div></div><p>Now let&rsquo;s consider that we are looking for a better level of protection. The <code>.data</code> section
is easy to dump during the execution of the binary so it is not the best spot to decode a sensitive string.</p><p><em>-> What about the stack? <i class="fa-solid fa-face-raised-eyebrow"></i></em></p><p>The stack has interesting anti-dump properties for this operation:</p><ol><li>The stack frame is local to a function (i.e not global as the <code>data</code> section)</li><li>The address where the string is decoded on the stack is not fixed at compile time
(compare to the <strong>relative</strong> virtual address of the data section)</li></ol><p>So the idea is to decode the string (from the <code>data</code> section) directly on the stack.</p><p>Let&rsquo;s consider this new version of the <code>check_code</code> function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-cpp data-lang=cpp><span style=display:flex;background-color:#3d3f4a><span><span style=color:#8be9fd>bool</span> <span style=color:#50fa7b>check_code</span>(<span style=color:#8be9fd>int</span> code, <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span> passwd) {
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> BANNER[] <span style=color:#ff79c6>=</span> R<span style=color:#f1fa8c>&#34;delim(</span>
</span></span><span style=display:flex><span>  Hello gentle reverser,
</span></span><span style=display:flex><span>  You are asked to enter the correct input that resolves <span style=color:#ff79c6>this</span> function.
</span></span><span style=display:flex><span>  Thank you<span style=color:#ff79c6>!</span>
</span></span><span style=display:flex><span>  )delim<span style=color:#f1fa8c>&#34;;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  printf(<span style=color:#f1fa8c>&#34;%s</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, BANNER);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>  <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> PASS[] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;OMVLL&#34;</span>;
</span></span><span style=display:flex;background-color:#3d3f4a><span>  <span style=color:#ff79c6>if</span> (code <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>47839</span> <span style=color:#ff79c6>||</span> strncmp(passwd, PASS, <span style=color:#bd93f9>6</span>)) {
</span></span><span style=display:flex><span>    LOG_ERROR(<span style=color:#f1fa8c>&#34;Wrong input&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>false</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>true</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If we want to protect the <code>"OMVLL"</code> string through a stack decoding, we can return the
<code>StringEncOptStack</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>obfuscate_string</span>(self, _, __, string: <span style=color:#8be9fd;font-style:italic>bytes</span>):
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> string<span style=color:#ff79c6>.</span>startswith(<span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#34;/home&#34;</span>) <span style=color:#ff79c6>and</span> string<span style=color:#ff79c6>.</span>endswith(<span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#34;.cpp&#34;</span>):
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;REDACTED&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#34;Hello gentle reverse&#34;</span> <span style=color:#ff79c6>in</span> string:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> omvll<span style=color:#ff79c6>.</span>StringEncOptGlobal()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>    <span style=color:#ff79c6>if</span> string <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#34;OMVLL&#34;</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span>        <span style=color:#ff79c6>return</span> omvll<span style=color:#ff79c6>.</span>StringEncOptStack()
</span></span></code></pre></div><p>With such an option, <code>b"OMVLL"</code> will be decoded as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> ENC_OMVLL <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\x1a\x9A\x21\x79\x37\x02</span><span style=color:#f1fa8c>&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#8be9fd>bool</span> <span style=color:#50fa7b>check_code</span>(<span style=color:#8be9fd>int</span> code) {
</span></span><span style=display:flex><span>  <span style=color:#8be9fd>char</span> OMVLL_DECODED[<span style=color:#bd93f9>6</span>];
</span></span><span style=display:flex;background-color:#3d3f4a><span>  OMVLL_DECODED[<span style=color:#bd93f9>1</span>] <span style=color:#ff79c6>=</span> ENC_OMVLL[<span style=color:#bd93f9>1</span>] <span style=color:#ff79c6>^</span> <span style=color:#bd93f9>0xd7</span>;
</span></span><span style=display:flex;background-color:#3d3f4a><span>  OMVLL_DECODED[<span style=color:#bd93f9>5</span>] <span style=color:#ff79c6>=</span> ENC_OMVLL[<span style=color:#bd93f9>5</span>] <span style=color:#ff79c6>^</span> <span style=color:#bd93f9>0x02</span>;
</span></span><span style=display:flex;background-color:#3d3f4a><span>  OMVLL_DECODED[<span style=color:#bd93f9>2</span>] <span style=color:#ff79c6>=</span> ENC_OMVLL[<span style=color:#bd93f9>2</span>] <span style=color:#ff79c6>^</span> <span style=color:#bd93f9>0x77</span>;
</span></span><span style=display:flex;background-color:#3d3f4a><span>  OMVLL_DECODED[<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>=</span> ENC_OMVLL[<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>^</span> <span style=color:#bd93f9>0x55</span>;
</span></span><span style=display:flex;background-color:#3d3f4a><span>  OMVLL_DECODED[<span style=color:#bd93f9>4</span>] <span style=color:#ff79c6>=</span> ENC_OMVLL[<span style=color:#bd93f9>4</span>] <span style=color:#ff79c6>^</span> <span style=color:#bd93f9>0x7b</span>;
</span></span><span style=display:flex;background-color:#3d3f4a><span>  OMVLL_DECODED[<span style=color:#bd93f9>3</span>] <span style=color:#ff79c6>=</span> ENC_OMVLL[<span style=color:#bd93f9>3</span>] <span style=color:#ff79c6>^</span> <span style=color:#bd93f9>0x35</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (code <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>47839</span> <span style=color:#ff79c6>||</span> strncmp(passwd, OMVLL_DECODED, <span style=color:#bd93f9>6</span>)) {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As we can observe, a stack buffer with the same size as the original string is allocated on the stack.
It is also worth highlighting some aspects of this protection:</p><ol><li>The indexes of the stack buffer where the <code>'char'</code> is decoded are shuffled.</li><li>The keystream used for decoding the string is unique.</li><li>The memory accesses of both, <code>OMVLL_DECODED</code> and <code>ENC_OMVLL</code> are protected with <a href=https://obfuscator.re/omvll/passes/opaque-fields-access/>Opaque Fields Access</a>.</li><li>The <code>xor</code> operation is protected with <a href=https://obfuscator.re/omvll/passes/arithmetic/>Arithmetic Obfuscation</a>.</li><li>Key&rsquo;s values are protected with <a href=https://obfuscator.re/omvll/passes/opaque-constants/>Opaque Constants</a>.</li></ol><p>So in the end, the compiled and protected binary looks like this:</p><figure class=figure><img-comparison-slider class=omvll><figure slot=first class=position-relative><img src=img/clear.webp></figure><figure slot=second class=position-relative><img src=img/inline.webp></figure><div slot=handle><i class="text-primary fa-sharp fa-solid fa-shield-cat fs-2"></i></div></img-comparison-slider></figure><p>As we can notice, this option <strong>drastically</strong> increases the code&rsquo;s size for which
<strong>the overhead is proportional</strong> to the original length of the string.</p><div class="alert d-flex alert-danger" role=alert style=max-width:1024px><i class="fa-regular fa-arrow-up-big-small lead me-3"></i><div>For these reasons and to avoid an important overhead, it is recommended to enable
this option on <strong>small and very sensitive</strong> strings.</div></div><p>Since this <code>StringEncOptStack</code> option can introduce <strong>a non-negligible overhead</strong> on large strings,
there is the possibility to tweak this protection by transforming the inlined decoding instructions into a loop:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>obfuscate_string</span>(self, _, __, string: <span style=color:#8be9fd;font-style:italic>bytes</span>):
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> string<span style=color:#ff79c6>.</span>startswith(<span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#34;/home&#34;</span>) <span style=color:#ff79c6>and</span> string<span style=color:#ff79c6>.</span>endswith(<span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#34;.cpp&#34;</span>):
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;REDACTED&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> <span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#34;Hello gentle reverse&#34;</span> <span style=color:#ff79c6>in</span> string:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> omvll<span style=color:#ff79c6>.</span>StringEncOptGlobal()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> string <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>b</span><span style=color:#f1fa8c>&#34;OMVLL&#34;</span>:
</span></span><span style=display:flex;background-color:#3d3f4a><span>    <span style=color:#ff79c6>return</span> omvll<span style=color:#ff79c6>.</span>StringEncOptStack(loopThreshold<span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>)
</span></span></code></pre></div><p>With this new <code>loopThreshold=0</code>, decoding of <code>b"OMVLL"</code> within <code>check_code</code> becomes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> ENC_OMVLL <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\x1a\x9A\x21\x79\x37\x02</span><span style=color:#f1fa8c>&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#8be9fd>bool</span> <span style=color:#50fa7b>check_code</span>(<span style=color:#8be9fd>int</span> code) {
</span></span><span style=display:flex><span>  <span style=color:#8be9fd>char</span> OMVLL_DECODED[<span style=color:#bd93f9>6</span>];
</span></span><span style=display:flex;background-color:#3d3f4a><span>  <span style=color:#ff79c6>for</span> (size_t i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>6</span>; <span style=color:#ff79c6>++</span>i) {
</span></span><span style=display:flex;background-color:#3d3f4a><span>    OMVLL_DECODED[i] <span style=color:#ff79c6>=</span> ENC_OMVLL[i] <span style=color:#ff79c6>^</span> KEY[i];
</span></span><span style=display:flex;background-color:#3d3f4a><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (code <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>47839</span> <span style=color:#ff79c6>||</span> strncmp(passwd, OMVLL_DECODED, <span style=color:#bd93f9>6</span>)) {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In doing so, the function which uses the string does not pay the cost of the inlined instructions. In the
current design of the pass (which aims at being improved):</p><ol><li>The key is a random <code>uint64_t</code> integer protected with <a href=https://obfuscator.re/omvll/passes/opaque-constants/>Opaque Constants</a>.</li><li>The <code>xor</code> operation is protected with MBA.</li><li>The previous operation changes pseudo-randomly.</li></ol><p>In other words, it follows this layout:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> ENC_OMVLL <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\x1a\x9A\x21\x79\x37\x02</span><span style=color:#f1fa8c>&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#8be9fd>bool</span> <span style=color:#50fa7b>check_code</span>(<span style=color:#8be9fd>int</span> code) {
</span></span><span style=display:flex><span>  <span style=color:#8be9fd>char</span> OMVLL_DECODED[<span style=color:#bd93f9>6</span>];
</span></span><span style=display:flex><span>  <span style=color:#8be9fd>uint64_t</span> KEY <span style=color:#ff79c6>=</span> Random();
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>for</span> (size_t i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>6</span>; <span style=color:#ff79c6>++</span>i) {
</span></span><span style=display:flex><span>    OMVLL_DECODED[i] <span style=color:#ff79c6>=</span> Op(ENC_OMVLL[i], KEY, i);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (code <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>47839</span> <span style=color:#ff79c6>||</span> strncmp(passwd, OMVLL_DECODED, <span style=color:#bd93f9>6</span>)) {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>On the final binary, it produces these changes:</p><figure class=figure><img-comparison-slider class=omvll><figure slot=first class=position-relative><img src=img/clear.webp></figure><figure slot=second class=position-relative><img src=img/loop.webp></figure><div slot=handle><i class="text-primary fa-sharp fa-solid fa-shield-cat fs-2"></i></div></img-comparison-slider></figure><p>Compares to the inlined stack decoding routine, this loop avoids the linear relationship between
the string&rsquo;s length and the code generated for its protection. Thus, this option can be triggered when
the string to protect is medium-sized and sensitive.</p><p>From an implementation perspective, the loop is dynamically jitted <strong>from C code</strong> which is something
pretty new compared to the other LLVM-based obfuscator. Feel free to jump on <a href=#implementation>Implementation</a>
for the details.</p><p>Here is the table that summarizes the different options:</p><table><thead><tr><th>Value Returned</th><th>Protection</th><th>Overhead</th></tr></thead><tbody><tr><td><code>False, None</code></td><td>None</td><td>None</td></tr><tr><td><code>True</code></td><td>Depends</td><td>Depends</td></tr><tr><td><code>StringEncOptGlobal</code></td><td>Medium</td><td>Low</td></tr><tr><td><code>StringEncOptStack(loopThreshold)</code></td><td>Medium++</td><td>Medium</td></tr><tr><td><code>StringEncOptStack()</code></td><td>High</td><td>Medium for small string, High for long strings</td></tr></tbody></table><h2 id=when-to-use-it>When to use it?</h2><p>This pass should always be enabled on your code, at least for checking and removing debug information or leaks
from macros.</p><p>For the other aspects of your code, you should consider enabling this protection for sensitive strings like
API Token (if any), log messages, secrets, etc.</p><p>Keep in mind that an insignificant string might be very significant for a reverse engineer even though it is not
directly related to a sensitive asset.</p><h2 id=implementation>Implementation</h2><p>This pass works by iterating over all the instructions of a function and by filtering on those
that access a <code>llvm::GlobalVariable</code>.</p><p>If the <code>GlobalVariable</code> is associated with a C-String, the pass calls
the user&rsquo;s callback to determine which protection should be used. Depending on the value returned by
the user&rsquo;s callback, the pass performs one of the following operations:</p><h3 id=stringencoptglobal>StringEncOptGlobal</h3><p>With this option, the pass replaces the original clear string with its encoded version:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#ff79c6>::</span>vector<span style=color:#ff79c6>&lt;</span><span style=color:#8be9fd>uint8_t</span><span style=color:#ff79c6>&gt;</span> encoded(str.size());
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Constant<span style=color:#ff79c6>*</span> StrEnc <span style=color:#ff79c6>=</span> ConstantDataArray<span style=color:#ff79c6>::</span>get(BB.getContext(), encoded);
</span></span><span style=display:flex><span>G.setInitializer(StrEnc);
</span></span></code></pre></div><p>Then, it injects the decoding function as a constructor of the current <code>llvm::Module</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#ff79c6>::</span>string Id <span style=color:#ff79c6>=</span> G.getGlobalIdentifier();
</span></span><span style=display:flex><span>FunctionCallee FCallee <span style=color:#ff79c6>=</span> module<span style=color:#ff79c6>-&gt;</span>getOrInsertFunction(Id, FVoidTy);
</span></span><span style=display:flex><span><span style=color:#ff79c6>auto</span><span style=color:#ff79c6>*</span> FCtor <span style=color:#ff79c6>=</span> cast<span style=color:#ff79c6>&lt;</span>Function<span style=color:#ff79c6>&gt;</span>(FCallee.getCallee());
</span></span><span style=display:flex><span>FCtor<span style=color:#ff79c6>-&gt;</span>setLinkage(llvm<span style=color:#ff79c6>::</span>GlobalValue<span style=color:#ff79c6>::</span>PrivateLinkage);
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>appendToGlobalCtors(module, FCtor, <span style=color:#bd93f9>0</span>);
</span></span></code></pre></div><p>This step is very similar to what we can observe in the O-LLVM&rsquo;s forks <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. Nevertheless, there is
one difference that matters in terms of reverse engineering:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-cpp data-lang=cpp><span style=display:flex><span>...
</span></span><span style=display:flex;background-color:#3d3f4a><span>FCtor<span style=color:#ff79c6>-&gt;</span>setLinkage(llvm<span style=color:#ff79c6>::</span>GlobalValue<span style=color:#ff79c6>::</span>PrivateLinkage);
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Actually, when using <code>getOrInsertFunction</code>, LLVM creates the function (if not already present) with a default
<strong>EXTERNAL</strong> visibility:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#6272a4>// In llvm/lib/IR/Module.cpp, as of LLVM 16
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>FunctionCallee Module<span style=color:#ff79c6>::</span>getOrInsertFunction(StringRef Name, FunctionType <span style=color:#ff79c6>*</span>Ty,
</span></span><span style=display:flex><span>                                           AttributeList AttributeList) {
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>F) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Nope, add it
</span></span></span><span style=display:flex;background-color:#3d3f4a><span><span style=color:#6272a4></span>    Function <span style=color:#ff79c6>*</span>New <span style=color:#ff79c6>=</span> Function<span style=color:#ff79c6>::</span>Create(Ty, GlobalVariable<span style=color:#ff79c6>::</span>ExternalLinkage,
</span></span><span style=display:flex><span>                                     DL.getProgramAddressSpace(), Name);
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This <code>ExternalLinkage</code> means that the constructor function will be considered as <strong>exported</strong> in
the final binary. Since the function is exported, its associated symbol <strong>can&rsquo;t be stripped</strong>.</p><p>In our implementation, the name of the constructor comes from <code>getGlobalIdentifier()</code> instead of <code>.datadiv_decode_...</code>:</p><div class="alert d-flex alert" role=alert><i class="fa-regular fa-file-circle-info fs-3 me-3"></i><figure><blockquote class="blockquote fst-italic">Return the modified name for this global value suitable to be used as the key for a global lookup (e.g. profile or ThinLTO).</blockquote><figcaption class=blockquote-footer>GlobalValue::getGlobalIdentifier() in <cite title="llvm documentation">llvm documentation</cite></figcaption></figure></div><p>but in most of the O-LLVM&rsquo;s forks the name of the constructor is set as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#8be9fd>uint64_t</span> StringObfDecodeRandomName <span style=color:#ff79c6>=</span> cryptoutils<span style=color:#ff79c6>-&gt;</span>get_uint64_t();
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>std<span style=color:#ff79c6>::</span>string Id <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;.datadiv_decode&#34;</span> <span style=color:#ff79c6>+</span> StringObfDecodeRandomName;
</span></span></code></pre></div><p>Since this name <strong>can&rsquo;t</strong> be stripped with an <code>ExternalLinkage</code>, the symbol is accessible from reverse engineers
who can immediately identify the purpose of the function. In addition, this symbol can be used as a marker to
fingerprint the obfuscator<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span>rule ollvm_v5_0_strenc <span style=color:#ff79c6>:</span> obfuscator
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  meta<span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>    description <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Obfuscator-LLVM version 5.0 (string encryption)&#34;</span>
</span></span><span style=display:flex><span>    url         <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;https://github.com/obfuscator-llvm/obfuscator/wiki&#34;</span>
</span></span><span style=display:flex><span>    sample      <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;a794a080a92987ce5ed9cf5cd872ef87f9bfb9acd4c07653b615f4beaff3ace2&#34;</span>
</span></span><span style=display:flex><span>    author      <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Eduardo Novella&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  strings<span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// &#34;Obfuscator-LLVM clang version 5.0.2  (based on Obfuscator-LLVM 5.0.2)&#34;
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    $clang_version <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Obfuscator-LLVM clang version 5.0.&#34;</span>
</span></span><span style=display:flex><span>    $based_on      <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;(based on Obfuscator-LLVM 5.0.&#34;</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>    $strenc        <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>/\.datadiv_decode[\d]{18,20}/</span>  <span style=color:#6272a4>// Enumerating elf.symtab_entries fails!
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span>  condition<span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>    is_elf and
</span></span><span style=display:flex><span>    all <span style=color:#ff79c6>of</span> them
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Once, we added the constructor with a proper visibility, the pending question is:</p><p><em>How to fill the constructor with instructions?</em></p><p>Basically, the constructor must contain the instructions that decode the encoded string. Thanks to the IR LLVM
API, we can manually create a loop, add the decoding operations, etc. This approach works and is efficient but
there are a few drawbacks:</p><ol><li>The decoding logic is not really modular: we have to manually write the routine with the <code>llvm::IRBuilder</code>.</li><li>It is error prone if the decoding logic is complex.</li></ol><p>On the other hand, LLVM also contains a JIT engine and a C/C++ frontend &ndash; aka clang &ndash; we could use
to dynamically JIT C/C++ source code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>llvm<span style=color:#ff79c6>::</span>Module<span style=color:#ff79c6>*</span> MJIT <span style=color:#ff79c6>=</span> TargetJIT<span style=color:#ff79c6>-&gt;</span>generate(R<span style=color:#f1fa8c>&#34;delim(</span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>decode</span>(<span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span> out, <span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span> in, <span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>long</span> <span style=color:#8be9fd>long</span> key, <span style=color:#8be9fd>int</span> size) {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span> raw_key <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span>)(<span style=color:#ff79c6>&amp;</span>key);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> size; <span style=color:#ff79c6>++</span>i) {
</span></span><span style=display:flex><span>      out[i] <span style=color:#ff79c6>=</span> in[i] <span style=color:#ff79c6>^</span> raw_key[i <span style=color:#ff79c6>%</span> <span style=color:#ff79c6>sizeof</span>(key)] <span style=color:#ff79c6>^</span> i;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>)delim<span style=color:#f1fa8c>&#34;);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Function<span style=color:#ff79c6>*</span> FDecode <span style=color:#ff79c6>=</span> MJIT<span style=color:#ff79c6>-&gt;</span>getFunction(<span style=color:#f1fa8c>&#34;decode&#34;</span>);
</span></span><span style=display:flex><span>CloneFunctionInto(FCtor, FDecode, ...);
</span></span></code></pre></div><p>Since a decoding routine is paired with an encoding routine, we can also JIT the encoding routine
(for the architecture on which O-MVLL is running),
to <em>&ldquo;blindly&rdquo;</em> encode the string:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#ff79c6>auto</span> JIT <span style=color:#ff79c6>=</span> HostJIT<span style=color:#ff79c6>-&gt;</span>compile(
</span></span><span style=display:flex><span>R<span style=color:#f1fa8c>&#34;delim(</span>
</span></span><span style=display:flex><span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>encode</span>(<span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span> out, <span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span> in, <span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>long</span> <span style=color:#8be9fd>long</span> key, <span style=color:#8be9fd>int</span> size) {
</span></span><span style=display:flex><span>   <span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span> raw_key <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span>)(<span style=color:#ff79c6>&amp;</span>key);
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> size; <span style=color:#ff79c6>++</span>i) {
</span></span><span style=display:flex><span>     out[i] <span style=color:#ff79c6>=</span> in[i] <span style=color:#ff79c6>^</span> raw_key[i <span style=color:#ff79c6>%</span> <span style=color:#ff79c6>sizeof</span>(key)] <span style=color:#ff79c6>^</span> i;
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>)delim<span style=color:#f1fa8c>&#34;);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>auto</span> E <span style=color:#ff79c6>=</span> HostJit<span style=color:#ff79c6>-&gt;</span>lookup(<span style=color:#f1fa8c>&#34;encode&#34;</span>)) {
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>auto</span> enc <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>reinterpret_cast</span><span style=color:#ff79c6>&lt;</span>enc_routine_t<span style=color:#ff79c6>&gt;</span>(E<span style=color:#ff79c6>-&gt;</span>getAddress());
</span></span><span style=display:flex><span>  enc(encoded.data(), str.data(), key, str.size());
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Constant<span style=color:#ff79c6>*</span> StrEnc <span style=color:#ff79c6>=</span> ConstantDataArray<span style=color:#ff79c6>::</span>get(BB.getContext(), encoded);
</span></span><span style=display:flex><span>G.setInitializer(StrEnc);
</span></span></code></pre></div><p>In its current implementation, the <code>encode/decode</code> functions are statically written in the code of the pass,
but we could also imagine supporting routines provided by the user through the Python API:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>obfuscate_string</span>(self, _, __, string: <span style=color:#8be9fd;font-style:italic>bytes</span>):
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>return</span> StringEncOpt(<span style=color:#f1fa8c>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    void encode(...) { /* My secret implementation */ }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    void decode(...) { /* My secret implementation */ }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  &#34;&#34;&#34;</span>)
</span></span></code></pre></div><p>You can find more details about the JIT engine used in O-MVLL in the section <a href=https://obfuscator.re/omvll/other-topics/jit/>LLVM JIT</a>.</p><h3 id=stringencoptstack-looped>StringEncOptStack Looped</h3><p>If the user returns the option <code>StringEncOptStack</code> for which the string is eligible to a loop, the pass
starts by allocating a buffer:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>AllocaInst<span style=color:#ff79c6>*</span> clearBuffer <span style=color:#ff79c6>=</span> IRB.CreateAlloca(IRB.getInt8Ty(),
</span></span><span style=display:flex><span>                                           IRB.getInt32(str.size()));
</span></span></code></pre></div><p>Then it injects the decoding routine using the same JIT-technique as <a href=#StringEncOptGlobal>StringEncOptGlobal</a>.</p><p>Finally, it replaces the original instruction&rsquo;s operand &ndash; which referenced the clear string &ndash; with the new stack buffer:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>I.setOperand(Op.getOperandNo(), clearBuffer);
</span></span></code></pre></div><h3 id=stringencoptstack-inline>StringEncOptStack Inline</h3><p>If the string must be inline-decoded on stack, the pass starts by allocating a buffer:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>AllocaInst<span style=color:#ff79c6>*</span> clearBuffer <span style=color:#ff79c6>=</span> IRB.CreateAlloca(IRB.getInt8Ty(),
</span></span><span style=display:flex><span>                                           IRB.getInt32(str.size()));
</span></span></code></pre></div><p>Then, the pass loops over the (shuffled) indexes of the string to individually create IR instructions that
decode the characters:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#ff79c6>for</span> (size_t i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> str.size(); <span style=color:#ff79c6>++</span>i) {
</span></span><span style=display:flex><span>  Value <span style=color:#ff79c6>*</span>EncGEP <span style=color:#ff79c6>=</span> IRB.CreateGEP(..., encBuffer  , ...);
</span></span><span style=display:flex><span>  Value<span style=color:#ff79c6>*</span> DecGEP <span style=color:#ff79c6>=</span> IRB.CreateGEP(..., clearBuffer, ...);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// Load the encoded character and its key
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  LoadInst<span style=color:#ff79c6>*</span> EncVal <span style=color:#ff79c6>=</span> IRB.CreateLoad(IRB.getInt8Ty(), EncGEP);
</span></span><span style=display:flex><span>  LoadInst<span style=color:#ff79c6>*</span> KeyVal <span style=color:#ff79c6>=</span> IRB.CreateLoad(...);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// Create the decode operation
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  Value<span style=color:#ff79c6>*</span> DecVal <span style=color:#ff79c6>=</span> IRB.CreateXor(EncVal, KeyVal);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// Store the decoded character
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  StoreInst<span style=color:#ff79c6>*</span> StoreClear <span style=color:#ff79c6>=</span> IRB.CreateStore(DecVal, DecGEP);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Without any additional protections, these IR-created instructions would be very easy to reverse. That&rsquo;s why
the pass also adds custom annotations (c.f. <a href=https://obfuscator.re/omvll/other-topics/annotations/>Obfuscation Annotations</a>)
to trigger other O-MVLL obfuscations:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#ff79c6>for</span> (size_t i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> str.size(); <span style=color:#ff79c6>++</span>i) {
</span></span><span style=display:flex><span>  Value <span style=color:#ff79c6>*</span>EncGEP <span style=color:#ff79c6>=</span> IRB.CreateGEP(..., encBuffer  , ...);
</span></span><span style=display:flex><span>  Value<span style=color:#ff79c6>*</span> DecGEP <span style=color:#ff79c6>=</span> IRB.CreateGEP(..., clearBuffer, ...);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// Load the encoded character and its key
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  LoadInst<span style=color:#ff79c6>*</span> EncVal <span style=color:#ff79c6>=</span> IRB.CreateLoad(IRB.getInt8Ty(), EncGEP);
</span></span><span style=display:flex;background-color:#3d3f4a><span>  addMetadata(<span style=color:#ff79c6>*</span>EncVal, MetaObf(PROTECT_FIELD_ACCESS));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  LoadInst<span style=color:#ff79c6>*</span> KeyVal <span style=color:#ff79c6>=</span> IRB.CreateLoad(...);
</span></span><span style=display:flex;background-color:#3d3f4a><span>  addMetadata(<span style=color:#ff79c6>*</span>KeyVal, MetaObf(PROTECT_FIELD_ACCESS));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// Create the decode operation
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  Value<span style=color:#ff79c6>*</span> DecVal <span style=color:#ff79c6>=</span> IRB.CreateXor(EncVal, KeyVal);
</span></span><span style=display:flex;background-color:#3d3f4a><span>  addMetadata(<span style=color:#ff79c6>*</span>DecVal, MetaObf(OPAQUE_OP, <span style=color:#bd93f9>2llu</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// Store the decoded character
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  StoreInst<span style=color:#ff79c6>*</span> StoreClear <span style=color:#ff79c6>=</span> IRB.CreateStore(DecVal, DecGEP);
</span></span><span style=display:flex;background-color:#3d3f4a><span>  addMetadata(<span style=color:#ff79c6>*</span>StoreClear, MetaObf(PROTECT_FIELD_ACCESS));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=limitations>Limitations</h2><p>As already mentioned at the beginning, a string protected with the option <code>StringEncOptGlobal</code> can be
easily recovered by dumping the <code>data</code> section once the binary is loaded. On the other hand, strings
protected with the <code>StringEncOptStack</code> option are not subject to the dump attack but they could be recovered
with a memory trace generated by a DBI (c.f. <a href=https://blog.quarkslab.com/android-native-library-analysis-with-qbdi.html#encoding-routine>Android Native Library Analysis with QBDI: Encoding Routine</a>).</p><p>Attackers could also use code lifting or emulation to automatically decode the strings. The scalability and
the feasibility of the code lifting and the emulation highly depend on the design of the function.</p><div class="alert d-flex alert-warning" role=alert style=max-width:1024px><i class="fa-brands fa-apple lead me-3"></i><div>This pass does not currently support Objective-C strings.</div></div><h2 id=references>References</h2><div class="card card-body dark-mode border-0 shadow-sm position-relative overflow-hidden ps-sm-5 mb-5 mt-5"><div class="position-absolute top-0 start-0 w-3 h-100 bg-success"></div><div class="d-flex align-items-start border-bottom pb-3"><i class="fa-regular fa-books fs-xl text-success"></i><div class="ps-2 ms-1"><h6 class="opacity-80 mb-1">Publications</h6></div></div><div class=pt-3><div class="d-flex ps-3 align-items-start pb-3"><i class="fa-light fa-link fs-xl text-success me-4 mt-1"></i><div><h6 class="opacity-80 mb-1"><a href=https://www.romainthomas.fr/post/21-07-pokemongo-anti-frida-jailbreak-bypass#what-about-lief target=_blank>Recovering Obfuscated Strings in PokemonGO</a></h6><p class="fs-sm mb-0">by <i>Romain Thomas</i></p></div></div><div class="d-flex ps-3 align-items-start pb-3"><i class="fa-light fa-link fs-xl text-success me-4 mt-1"></i><div><h6 class="opacity-80 mb-1"><a href=https://www.synthesis.to/2021/06/30/automating_string_decryption.html target=_blank>Automation in Reverse Engineering: String Decryption</a></h6><p class="fs-sm mb-0">by <i>Tim Blazytko</i></p></div></div></div></div><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>See for instance: <a href=https://github.com/kk-laoguo/ollvm-13/blob/e4fdfebfc7da3e89469d9e6095c3486029cea106/llvm-project-13/llvm/lib/Transforms/Obfuscation/StringObfuscation.cpp#L121-L139>kk-laoguo/ollvm-13</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://github.com/rednaga/APKiD/blob/a50ee3b4a42a3e1a284af9eafa79e41ee80bc59f/apkid/rules/elf/obfuscators.yara#L100-L117>apkid/rules/elf/obfuscators.yara</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></div><nav class=pb-5><ul class="pagination d-flex justify-content-left"><li class=page-item><a href=https://obfuscator.re/omvll/passes/opaque-fields-access/ class=page-link><i class="fa-regular fa-chevrons-left ms-n1 me-1 fs-xs"></i>
Opaque Fields Access</a></li><li class=page-item><a href=https://obfuscator.re/omvll/other-topics/ class=page-link>Other Topics
<i class="fa-regular fa-chevrons-right me-n1 ms-1 fs-xs"></i></a></li></ul></nav></main><aside id=jumpToNav class="side-nav side-nav-end d-none d-xxl-block position-fixed top-0 end-0 vh-100 py-5" style=width:20rem><h3 class="fs-lg mt-5 pt-5">Jump to</h3><ul class=nav><li class=nav-item><a class=nav-link href=#how-to-use-it data-scroll data-scroll-offset=-6>How to use it?</a></li><li class=nav-item><a class=nav-link href=#when-to-use-it data-scroll data-scroll-offset=-6>When to use it?</a></li><li class=nav-item><a class=nav-link href=#implementation data-scroll data-scroll-offset=-6>Implementation</a></li><li class=nav-item><a class=nav-link href=#limitations data-scroll data-scroll-offset=-6>Limitations</a></li><li class=nav-item><a class=nav-link href=#references data-scroll data-scroll-offset=-6>References</a></li></ul></aside></main><footer class="footer dark-mode bg-dark pt-5 pb-4 pb-lg-5"><div class="container text-center pt-lg-3"><p class="nav d-block fs-sm text-center pt-5 mt-lg-4 mb-0"><span class="text-light opacity-50">Site generated with</span>
<a class="nav-link d-inline-block p-0" href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a>
<span class="text-light opacity-50">and created by</span>
<a class="nav-link d-inline-block p-0" href=https://www.romainthomas.fr/ target=_blank rel=noopener>R. Thomas</a></p></div></footer><noscript><div class="navbar navbar-expand-lg navbar-dark shadow-sm fixed-bottom d-flex justify-content-center align-items-center"><div class="alert alert-warning fade show" role=alert><i class="fa-solid fa-gingerbread-man me-2"></i>
This website is free from cookies, trackers, and ads but you might want to enable javascript for a
better UI experience.</div></div></noscript><script src=/vendor/bootstrap/dist/js/bootstrap.bundle.min.js></script>
<script src=/vendor/smooth-scroll/dist/smooth-scroll.polyfills.min.js></script>
<script src=/vendor/parallax-js/dist/parallax.min.js></script>
<script src=/vendor/jarallax/dist/jarallax.min.js></script>
<script src=/vendor/rellax/rellax.min.js></script>
<script src=/vendor/swiper/swiper-bundle.min.js></script>
<script src=/vendor/lightgallery/lightgallery.min.js></script>
<script src=/vendor/lightgallery/plugins/video/lg-video.min.js></script>
<script>jarallax(document.querySelectorAll(".jarallax"),{speed:.2})</script><script src=/vendor/img-comparison-slider/dist/index.js></script>
<script src=/js/theme.min.js></script>
<script src=/js/anime.min.js></script></body></html>